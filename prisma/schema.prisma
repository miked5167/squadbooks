// Squadbooks + Association Dashboard - Unified Schema
// Combines team-level budget management with association-level oversight

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ASSOCIATION MODELS
// ============================================

model Association {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String   @db.VarChar(255)
  abbreviation  String?  @db.VarChar(32)
  provinceState String?  @map("province_state") @db.VarChar(64)
  country       String?  @db.VarChar(64)
  logoUrl       String?  @map("logo_url") @db.VarChar(500)
  season        String?  @db.VarChar(32) // e.g., "2025-2026"
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  users         AssociationUser[]
  teams         AssociationTeam[]
  alerts        Alert[]
  reports       Report[]
  config        DashboardConfig?

  @@map("associations")
}

model AssociationUser {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  associationId String    @map("association_id") @db.Uuid
  clerkUserId   String    @unique @map("clerk_user_id") @db.VarChar(255)
  email         String    @db.VarChar(255)
  name          String?   @db.VarChar(255)
  role          String    @db.VarChar(32) // 'association_admin', 'board_member', 'auditor'
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  reports       Report[]
  alertsResolved Alert[]   @relation("AlertResolvedBy")
  teamUsers     User[]     // Link to team users who also have association access

  @@map("association_users")
}

model AssociationTeam {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  associationId     String    @map("association_id") @db.Uuid

  // Link to Team model (changed from external string to internal CUID reference)
  teamId            String?   @map("team_id") // CUID reference to Team.id, nullable for legacy teams
  teamName          String    @map("team_name") @db.VarChar(255)
  division          String?   @db.VarChar(64)
  season            String?   @db.VarChar(32)

  // OAuth / connection
  apiAccessToken    String?   @map("api_access_token") @db.Text
  tokenExpiresAt    DateTime? @map("token_expires_at") @db.Timestamptz
  connectedAt       DateTime? @map("connected_at") @db.Timestamptz
  lastSyncedAt      DateTime? @map("last_synced_at") @db.Timestamptz

  // State
  isActive          Boolean   @default(true) @map("is_active")

  // Treasurer info (read-only mirror)
  treasurerName     String?   @map("treasurer_name") @db.VarChar(255)
  treasurerEmail    String?   @map("treasurer_email") @db.VarChar(255)

  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  association       Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  team              Team?       @relation(fields: [teamId], references: [id])
  snapshots         TeamFinancialSnapshot[]
  alerts            Alert[]

  @@unique([teamId]) // Each team can only belong to one association
  @@unique([associationId, teamId])
  @@index([teamId])
  @@map("association_teams")
}

model TeamFinancialSnapshot {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  associationTeamId     String    @map("association_team_id") @db.Uuid

  snapshotAt            DateTime  @default(now()) @map("snapshot_at") @db.Timestamptz

  // Health
  healthStatus          String    @map("health_status") @db.VarChar(16) // 'healthy', 'needs_attention', 'at_risk'
  healthScore           Int?      @map("health_score")

  // Budget figures
  budgetTotal           Decimal?  @map("budget_total") @db.Decimal(10, 2)
  spent                 Decimal?  @db.Decimal(10, 2)
  remaining             Decimal?  @db.Decimal(10, 2)
  percentUsed           Decimal?  @map("percent_used") @db.Decimal(5, 2)

  // Operational metrics
  pendingApprovals      Int?      @map("pending_approvals")
  missingReceipts       Int?      @map("missing_receipts")
  bankReconciledThrough DateTime? @map("bank_reconciled_through") @db.Date
  bankConnected         Boolean?  @map("bank_connected")
  lastActivityAt        DateTime? @map("last_activity_at") @db.Timestamptz

  // Flags
  redFlags              Json?     @map("red_flags")

  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  team                  AssociationTeam @relation(fields: [associationTeamId], references: [id], onDelete: Cascade)

  @@index([associationTeamId, snapshotAt(sort: Desc)], name: "idx_snapshots_team_time")
  @@map("team_financial_snapshots")
}

model Alert {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  associationId     String    @map("association_id") @db.Uuid
  associationTeamId String    @map("association_team_id") @db.Uuid

  alertType         String    @map("alert_type") @db.VarChar(64)
  severity          String    @db.VarChar(16) // 'warning', 'critical'

  title             String    @db.VarChar(255)
  description       String?   @db.Text

  status            String    @default("active") @db.VarChar(16) // 'active', 'resolved'
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  resolvedAt        DateTime? @map("resolved_at") @db.Timestamptz
  resolvedBy        String?   @map("resolved_by") @db.Uuid

  lastTriggeredAt   DateTime  @default(now()) @map("last_triggered_at") @db.Timestamptz

  notes             String?   @db.Text

  // Relations
  association       Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  team              AssociationTeam @relation(fields: [associationTeamId], references: [id], onDelete: Cascade)
  resolver          AssociationUser? @relation("AlertResolvedBy", fields: [resolvedBy], references: [id])

  @@index([associationId, status, severity, createdAt(sort: Desc)], name: "idx_alerts_active")
  @@unique([associationTeamId, alertType, status], name: "uq_active_alert")
  @@map("alerts")
}

model Report {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  associationId   String    @map("association_id") @db.Uuid
  generatedBy     String    @map("generated_by") @db.Uuid

  reportType      String    @map("report_type") @db.VarChar(32)
  dateRangeStart  DateTime? @map("date_range_start") @db.Date
  dateRangeEnd    DateTime? @map("date_range_end") @db.Date

  fileUrl         String?   @map("file_url") @db.VarChar(500)
  generatedAt     DateTime  @default(now()) @map("generated_at") @db.Timestamptz

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  generator       AssociationUser @relation(fields: [generatedBy], references: [id])

  @@index([associationId, reportType, generatedAt(sort: Desc)], name: "idx_reports_association_type_time")
  @@map("reports")
}

model DashboardConfig {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  associationId           String   @unique @map("association_id") @db.Uuid

  // Budget thresholds
  budgetWarningPct        Decimal  @default(80.0) @map("budget_warning_pct") @db.Decimal(5, 2)
  budgetCriticalPct       Decimal  @default(95.0) @map("budget_critical_pct") @db.Decimal(5, 2)

  // Bank reconciliation thresholds (days)
  bankWarningDays         Int      @default(30) @map("bank_warning_days")
  bankCriticalDays        Int      @default(60) @map("bank_critical_days")

  // Pending approvals thresholds
  approvalsWarningCount   Int      @default(5) @map("approvals_warning_count")
  approvalsCriticalCount  Int      @default(10) @map("approvals_critical_count")

  // Inactivity threshold (days)
  inactivityWarningDays   Int      @default(21) @map("inactivity_warning_days")

  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  association             Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@map("dashboard_config")
}

// ============================================
// TEAM MODELS (Squadbooks)
// ============================================

model Team {
  id          String   @id @default(cuid())
  name        String
  level       String // "U8", "U10", "U13", etc.
  season      String // "2024-2025"
  budgetTotal Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users             User[]
  categories        Category[]
  transactions      Transaction[]
  budgetAllocations BudgetAllocation[]
  bankAccounts      BankAccount[]
  auditLogs         AuditLog[]
  exports           Export[]
  approvals         Approval[]
  invitations       Invitation[]
  seasonClosures    SeasonClosure[]
  families          Family[]
  associationTeam   AssociationTeam? // Link to association dashboard (optional)

  @@map("teams")
}

model Family {
  id             String   @id @default(cuid())
  teamId         String
  familyName     String
  primaryEmail   String
  secondaryEmail String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@map("families")
}

enum UserRole {
  TREASURER
  ASSISTANT_TREASURER
  PRESIDENT
  BOARD_MEMBER
  PARENT
  AUDITOR
}

model User {
  id      String   @id @default(cuid())
  clerkId String   @unique
  email   String   @unique
  name    String
  role    UserRole @default(PARENT)
  teamId  String

  // Optional link to association user (for users who have both team and association roles)
  associationUserId String? @map("association_user_id") @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team                   Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  associationUser        AssociationUser? @relation(fields: [associationUserId], references: [id])
  transactionsCreated    Transaction[]   @relation("TransactionCreator")
  approvalsCreated       Approval[]      @relation("ApprovalCreator")
  approvalsApproved      Approval[]      @relation("Approver")
  auditLogs              AuditLog[]
  exports                Export[]
  seasonClosures         SeasonClosure[] @relation("SeasonClosureSubmitter")

  @@index([teamId])
  @@index([clerkId])
  @@index([associationUserId])
  @@map("users")
}

enum CategoryType {
  EXPENSE
  INCOME
}

model Category {
  id        String       @id @default(cuid())
  teamId    String
  name      String
  heading   String       // "Ice Time", "Equipment", etc.
  color     String       @default("#3B82F6")
  type      CategoryType @default(EXPENSE)
  sortOrder Int          @default(0)
  isDefault Boolean      @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team              Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  budgetAllocations BudgetAllocation[]

  @@index([teamId])
  @@map("categories")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

model Transaction {
  id              String            @id @default(cuid())
  teamId          String
  type            TransactionType
  status          TransactionStatus @default(DRAFT)
  amount          Decimal           @db.Decimal(10, 2)
  categoryId      String
  vendor          String
  description     String?           @db.Text
  transactionDate DateTime
  receiptUrl      String?
  receiptPath     String? // Storage path for file deletion
  createdBy       String
  deletedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  category  Category   @relation(fields: [categoryId], references: [id])
  creator   User       @relation("TransactionCreator", fields: [createdBy], references: [id])
  approvals Approval[]

  @@index([teamId])
  @@index([categoryId])
  @@index([createdBy])
  @@index([transactionDate])
  @@index([status])
  @@map("transactions")
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model Approval {
  id            String         @id @default(cuid())
  transactionId String
  approvedBy    String
  createdBy     String
  status        ApprovalStatus @default(PENDING)
  comment       String?        @db.Text
  approvedAt    DateTime?
  teamId        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  approver    User        @relation("Approver", fields: [approvedBy], references: [id])
  creator     User        @relation("ApprovalCreator", fields: [createdBy], references: [id])
  team        Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([approvedBy])
  @@index([status])
  @@index([teamId])
  @@map("approvals")
}

model BudgetAllocation {
  id         String  @id @default(cuid())
  teamId     String
  categoryId String
  season     String // "2024-2025"
  allocated  Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([teamId, categoryId, season])
  @@index([teamId])
  @@index([categoryId])
  @@map("budget_allocations")
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  teamId     String
  userId     String
  action     String // "CREATE_TRANSACTION", "APPROVE_EXPENSE", etc.
  entityType String // "Transaction", "Approval", etc.
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([teamId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// FUTURE FEATURES (Phase 2)
// ============================================

enum BankAccountType {
  CHECKING
  SAVINGS
}

model BankAccount {
  id              String          @id @default(cuid())
  teamId          String
  accountName     String
  accountType     BankAccountType
  lastFour        String
  currentBalance  Decimal         @db.Decimal(10, 2)
  isActive        Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team             Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  bankTransactions BankTransaction[]

  @@index([teamId])
  @@map("bank_accounts")
}

model BankTransaction {
  id                String   @id @default(cuid())
  bankAccountId     String
  date              DateTime
  description       String
  amount            Decimal  @db.Decimal(10, 2)
  transactionId     String? // Link to Transaction if matched
  isReconciled      Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId])
  @@index([date])
  @@map("bank_transactions")
}

enum ExportFormat {
  CSV
  PDF
  EXCEL
}

model Export {
  id         String       @id @default(cuid())
  teamId     String
  userId     String
  format     ExportFormat
  reportType String // "monthly_summary", "budget_variance", "transaction_history"
  fileUrl    String
  createdAt  DateTime     @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([teamId])
  @@index([userId])
  @@map("exports")
}

model Invitation {
  id         String    @id @default(cuid())
  teamId     String
  email      String
  name       String
  role       UserRole
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([email])
  @@index([token])
  @@map("invitations")
}

// ============================================
// SEASON CLOSURE
// ============================================

enum SeasonClosureStatus {
  DRAFT        // Treasurer is preparing closure
  VALIDATING   // Validation is running / in progress
  READY        // Validation passed; ready to submit
  SUBMITTED    // Package generated + sent
  ACKNOWLEDGED // Association confirmed receipt
  ARCHIVED     // Historical record
}

model SeasonClosure {
  id        String   @id @default(cuid())
  teamId    String
  season    String   // e.g. "2024-2025"

  // Status
  status    SeasonClosureStatus @default(DRAFT)

  // Validation flags (snapshot at time of submission)
  budgetBalanced         Boolean @default(false)
  allTransactionsApproved Boolean @default(false)
  allReceiptsPresent     Boolean @default(false)
  bankReconciled         Boolean @default(false)

  // Financial summary (snapshot values)
  totalIncome            Decimal  @db.Decimal(10, 2) @default(0)
  totalExpenses          Decimal  @db.Decimal(10, 2) @default(0)
  finalBalance           Decimal  @db.Decimal(10, 2) @default(0)

  // Policy snapshot (JSON copy of association rules / thresholds at closure time)
  policySnapshot         Json?

  // Submission details
  associationEmail       String?
  submittedAt            DateTime?
  submittedBy            String?  // User ID of treasurer
  packageUrl             String?  // Storage URL for the ZIP

  // Acknowledgement from association (optional)
  acknowledgedAt         DateTime?
  acknowledgedBy         String?  // Name/email of association contact

  // Metadata
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relationships
  team                   Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  submitter              User?    @relation("SeasonClosureSubmitter", fields: [submittedBy], references: [id])

  @@unique([teamId, season])
  @@index([teamId])
  @@index([status])
  @@map("season_closures")
}
