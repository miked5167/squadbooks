---
phase: 04-polish-and-production-readiness
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/security/association-read-only.spec.ts
  - lib/db/transactions.ts
autonomous: true

must_haves:
  truths:
    - 'Association users cannot create transactions via API'
    - 'Association users cannot update transactions via API'
    - 'Association users cannot delete transactions via API'
    - 'Association users cannot upload receipts via API'
    - 'All mutation endpoints return 403 for association users'
  artifacts:
    - path: 'tests/security/association-read-only.spec.ts'
      provides: 'Security audit test suite for association read-only enforcement'
      min_lines: 100
    - path: 'lib/db/transactions.ts'
      provides: 'Verified DAL pattern with session checks'
      contains: 'verifySession'
  key_links:
    - from: 'tests/security/association-read-only.spec.ts'
      to: 'app/api/transactions'
      via: 'HTTP requests to mutation endpoints'
      pattern: 'POST|PUT|DELETE|PATCH'
---

<objective>
Systematically verify that association users have read-only access by testing all mutation paths and confirming DAL pattern implementation.

Purpose: Satisfy success criteria "Security audit confirms no mutation paths exist for association role" and address CVE-2025-29927 concerns (middleware-only auth is insufficient).

Output: Comprehensive security audit test suite, verified DAL pattern, documented mutation endpoint audit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish-and-production-readiness/04-CONTEXT.md
@.planning/phases/04-polish-and-production-readiness/04-RESEARCH.md
@.planning/phases/01-security-foundation-and-infrastructure/01-01-SUMMARY.md
@lib/permissions/server-permissions.ts
@lib/auth/server-auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Mutation API Routes for Permission Checks</name>
  <files>tests/security/association-read-only.spec.ts</files>
  <action>
Create security audit test suite based on RESEARCH.md Pattern 8 (Security Audit for Read-Only Access).

Tests to create:

1. Transaction creation blocked:
   - Mock association user context
   - Attempt POST to /api/transactions
   - Expect 403 Forbidden
   - Verify error message matches read-only pattern

2. Transaction update blocked:
   - Mock association user context
   - Attempt PUT/PATCH to /api/transactions/[id]
   - Expect 403 Forbidden

3. Transaction deletion blocked:
   - Mock association user context
   - Attempt DELETE to /api/transactions/[id]
   - Expect 403 Forbidden

4. Receipt upload blocked:
   - Mock association user context
   - Attempt POST to receipt upload endpoint
   - Expect 403 Forbidden

5. Team modification blocked:
   - Mock association user context
   - Attempt PUT/DELETE to team endpoints
   - Expect 403 Forbidden

Use Vitest for integration tests (follow pattern from 01-01-SUMMARY.md which used vi.mock for Clerk auth).

Reference STATE.md Decision: "Consistent 403 error message for read-only users" - verify messages match pattern.

Document in test comments: "Security audit addressing CVE-2025-29927 - verifies DAL pattern, not middleware-only auth"
</action>
<verify>
File exists at tests/security/association-read-only.spec.ts
Test suite includes 5+ test cases covering mutations
Tests mock association user context
Tests assert 403 responses for mutation attempts
TypeScript compilation passes
</verify>
<done>
Security audit test suite created to verify read-only enforcement at API layer.
</done>
</task>

<task type="auto">
  <name>Task 2: Verify Data Access Layer (DAL) Pattern</name>
  <files>lib/db/transactions.ts</files>
  <action>
Audit existing transaction data access functions to verify DAL pattern implementation.

Check for (per RESEARCH.md Pattern 8 and Next.js official guidance):

1. Session verification at function entry:
   - Functions should call verifySession() or similar auth check
   - Should throw error if session invalid

2. Permission checks before database operations:
   - Association user checks should happen before Prisma queries
   - Should verify user belongs to association for scoped queries

3. Read-only functions separate from mutation functions:
   - getTransactionsForAssociation should be read-only
   - No createTransaction, updateTransaction, deleteTransaction for association users

If DAL pattern is NOT fully implemented:

- Add session verification to data access functions
- Add comments documenting DAL pattern per Next.js guidance
- Ensure association-scoped functions don't allow mutations

If DAL pattern IS implemented:

- Add code comments documenting the pattern for maintainability
- Verify session checks happen before database queries

Reference: RESEARCH.md Pitfall 4 (Middleware-Only Security) and official Next.js guidance.

Do NOT remove existing permission checks - only add or document DAL pattern.
</action>
<verify>
lib/db/transactions.ts contains session verification calls
Read-only functions documented with DAL pattern comments
No mutation paths exist for association user data access
TypeScript compilation passes
Code comments reference Next.js DAL pattern
</verify>
<done>
DAL pattern verified or enhanced, documented for maintainability and security.
</done>
</task>

<task type="auto">
  <name>Task 3: Run Security Audit and Document Results</name>
  <files>tests/security/association-read-only.spec.ts</files>
  <action>
Execute security audit test suite and document results.

Steps:

1. Run security tests: npm test tests/security/association-read-only.spec.ts
2. Verify all tests pass (all mutation attempts return 403)
3. Document results in test file header comments:
   - Date of audit
   - Tests passed
   - Confirmed: Association users have read-only access at API layer
   - Confirmed: DAL pattern implemented (not middleware-only)

If any tests fail:

- Investigate why mutation is allowed
- Fix permission check in API route or data access layer
- Re-run tests until all pass

Add comment at top of test file:

```typescript
/**
 * Security Audit: Association User Read-Only Access
 *
 * Verifies that association users cannot mutate data via API endpoints.
 * Addresses CVE-2025-29927 by testing DAL pattern (not middleware-only auth).
 *
 * Last audit: [DATE]
 * Status: [PASS/FAIL]
 *
 * Coverage:
 * - Transaction mutations (create, update, delete)
 * - Receipt uploads
 * - Team modifications
 */
```

This task includes running the tests and documenting pass/fail results.
</action>
<verify>
Security audit tests execute successfully
All tests pass (403 responses for all mutation attempts)
Test file contains audit documentation header
Test results logged to console or test report
No mutations allowed for association users
</verify>
<done>
Security audit executed, all tests pass, association users confirmed read-only at API layer.
</done>
</task>

</tasks>

<verification>
Run security audit test suite:

```bash
# Run security audit tests
npm test tests/security/association-read-only.spec.ts
```

Manual verification:

- All security tests pass
- 403 responses for all mutation attempts
- Error messages are consistent with read-only pattern
- DAL pattern documented in lib/db/transactions.ts
- Test file contains audit documentation header

Check for mutation endpoints:

```bash
# Find all mutation routes
grep -r "POST\|PUT\|DELETE\|PATCH" app/api/transactions
```

Verify each mutation endpoint has permission check rejecting association users.
</verification>

<success_criteria>

- [ ] Security audit test suite created with 5+ test cases
- [ ] All tests verify 403 responses for association user mutations
- [ ] DAL pattern verified in lib/db/transactions.ts
- [ ] Session verification documented in data access functions
- [ ] Test suite passes (all mutations blocked)
- [ ] Audit documentation header added to test file
- [ ] No mutation paths exist for association users
      </success_criteria>

<output>
After completion, create `.planning/phases/04-polish-and-production-readiness/04-04-SUMMARY.md`
</output>
