---
phase: 03-enhanced-filtering-pdf-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/transactions/route.ts
  - components/transactions/DateRangeFilter.tsx
  - components/transactions/MissingReceiptsToggle.tsx
  - components/transactions/TransactionSearch.tsx
  - components/transactions/FilterChips.tsx
  - app/association/[associationId]/transactions/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Association user can filter transactions by date range using from/to date pickers'
    - "Association user can toggle 'missing receipts only' filter to show transactions without receipts"
    - 'Association user can search transactions by vendor name or description with debounced input'
    - 'Applied filters display as removable chips above transaction list'
    - 'Filter state persists in URL and is shareable/bookmarkable'
  artifacts:
    - path: 'app/api/transactions/route.ts'
      provides: 'API supports dateFrom, dateTo, missingReceipts query params'
      exports: ['GET']
      contains: 'dateFrom.*dateTo.*missingReceipts'
    - path: 'components/transactions/DateRangeFilter.tsx'
      provides: 'Date range picker with presets (Last 7/30 days, This month)'
      min_lines: 80
    - path: 'components/transactions/MissingReceiptsToggle.tsx'
      provides: 'Toggle switch for missing receipts filter'
      min_lines: 30
    - path: 'components/transactions/TransactionSearch.tsx'
      provides: 'Debounced search input for vendor/description'
      min_lines: 40
    - path: 'components/transactions/FilterChips.tsx'
      provides: 'Removable chips for active filters with clear all button'
      min_lines: 50
    - path: 'app/association/[associationId]/transactions/page.tsx'
      provides: 'Integrated filter controls in horizontal row above table'
      exports: ['default']
  key_links:
    - from: 'app/api/transactions/route.ts'
      to: 'prisma.transaction.findMany'
      via: 'where clause with transactionDate and receiptUrl filters'
      pattern: 'transactionDate.*gte|lte|receiptUrl.*null'
    - from: 'components/transactions/DateRangeFilter.tsx'
      to: 'URL searchParams (dateFrom, dateTo)'
      via: 'router.push with URLSearchParams'
      pattern: "params\\.set\\('dateFrom'|'dateTo'"
    - from: 'components/transactions/TransactionSearch.tsx'
      to: 'URL searchParams (search)'
      via: 'debounced useEffect -> router.push'
      pattern: "setTimeout.*router\\.push"
    - from: 'components/transactions/FilterChips.tsx'
      to: 'URL searchParams removal'
      via: 'onRemove -> router.push'
      pattern: "params\\.delete"
    - from: 'app/association/[associationId]/transactions/page.tsx'
      to: '/api/transactions'
      via: 'useEffect watches searchParams -> fetch with filters'
      pattern: "searchParams\\.get.*fetch"
---

<objective>
Add advanced filter controls (date range, missing receipts, vendor/description search) and filter chips to association transactions page with URL state persistence.

Purpose: Enable association users to quickly find specific transactions across teams by filtering on multiple dimensions.
Output: Fully functional filter controls with URL-driven state, removable chips, and backend API support for all filter parameters.

Note: FILTER-01 (team multi-select) is already satisfied by existing TeamFilter.tsx component from Phase 2. This plan adds the remaining filter requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-CONTEXT.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-RESEARCH.md
@.planning/phases/02-association-dashboard-view/02-01-SUMMARY.md

# Existing patterns to extend

@components/transactions/TeamFilter.tsx
@app/association/[associationId]/transactions/page.tsx
@app/api/transactions/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance API Route to Support Date and Receipt Filters</name>
  <files>app/api/transactions/route.ts</files>
  <action>
Modify /api/transactions GET handler to support dateFrom, dateTo, and missingReceipts query parameters:

1. Parse new query params after existing params (line ~48):
   - dateFrom: ISO date string (YYYY-MM-DD)
   - dateTo: ISO date string (YYYY-MM-DD)
   - missingReceipts: 'true' | 'false' (boolean string)

2. Add to filters object type definition:

   ```typescript
   const filters: {
     // ... existing filters
     dateFrom?: string
     dateTo?: string
     missingReceipts?: boolean
   } = {}
   ```

3. Parse and validate date parameters:

   ```typescript
   const dateFromParam = searchParams.get('dateFrom')
   const dateToParam = searchParams.get('dateTo')
   const missingReceiptsParam = searchParams.get('missingReceipts')

   if (dateFromParam) {
     filters.dateFrom = dateFromParam // Will be converted to Date in getTransactionsWithCursor
   }
   if (dateToParam) {
     filters.dateTo = dateToParam
   }
   if (missingReceiptsParam === 'true') {
     filters.missingReceipts = true
   }
   ```

4. Update getTransactionsWithCursor function in lib/db/transactions.ts to handle new filters:
   - Add dateFrom/dateTo to where clause: `transactionDate: { gte: new Date(filters.dateFrom), lte: new Date(filters.dateTo) }`
   - Add missingReceipts to where clause: `receiptUrl: filters.missingReceipts ? null : undefined`
   - Only apply date filters if both dateFrom and dateTo are present (partial ranges not supported)

Existing API handles: teamIds, limit, cursor, type, status, categoryId, search.
These new filters are additive and work with existing filters.
</action>
<verify>
API compiles without errors:

```bash
npx tsc --noEmit
```

Search for new filter parsing:

```bash
grep -n "dateFrom\|dateTo\|missingReceipts" app/api/transactions/route.ts
```

Test API manually with filters:

```bash
curl "http://localhost:3000/api/transactions?dateFrom=2026-01-01&dateTo=2026-01-19&limit=5"
curl "http://localhost:3000/api/transactions?missingReceipts=true&limit=5"
```

Expected: Returns filtered transactions matching date range and/or missing receipts condition.
</verify>
<done>

- API route parses dateFrom, dateTo, missingReceipts query parameters
- filters object includes new filter types
- lib/db/transactions.ts getTransactionsWithCursor function applies date range filter (transactionDate gte/lte)
- lib/db/transactions.ts applies missing receipts filter (receiptUrl: null)
- Date strings converted to Date objects for Prisma queries
- Filters work in combination with existing filters (search, teamIds, etc.)
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create Date Range Filter Component</name>
  <files>components/transactions/DateRangeFilter.tsx</files>
  <action>
Create DateRangeFilter.tsx as a client component that:
- Uses react-day-picker in range mode with 2 months side-by-side (desktop) and 1 month (mobile)
- Includes preset buttons: "Last 7 days", "Last 30 days", "This month", "Clear"
- Reads dateFrom/dateTo from useSearchParams on mount to initialize range
- Updates URL searchParams when date range changes via router.push
- Deletes cursor param when filters change (reset pagination)
- Uses { scroll: false } to prevent page jump
- Formats dates as YYYY-MM-DD (ISO date strings, no timezone) for URL
- Uses Radix UI Popover + Button trigger with CalendarIcon
- Displays selected range in trigger button text (e.g., "Jan 15 - Feb 10, 2026" or "Select date range")

Follow the exact pattern from RESEARCH.md > Code Examples > Date Range Filter with Presets.
Use date-fns functions: format, subDays, startOfMonth, endOfMonth.
Import Calendar from @/components/ui/calendar (uses react-day-picker).
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Search for key patterns:

```bash
grep -n "useSearchParams\|router.push\|dateFrom\|dateTo" components/transactions/DateRangeFilter.tsx
```

  </verify>
  <done>
- DateRangeFilter.tsx exists with DateRange import from react-day-picker
- Component reads/writes dateFrom and dateTo searchParams
- Preset buttons included (Last 7/30 days, This month, Clear)
- Uses Popover + Calendar with range mode and 2 months display
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Missing Receipts Toggle Component</name>
  <files>components/transactions/MissingReceiptsToggle.tsx</files>
  <action>
Create MissingReceiptsToggle.tsx as a client component that:
- Uses Radix UI Switch component with Label
- Reads missingReceipts param from useSearchParams (checked if value is 'true')
- When toggled ON: sets missingReceits=true in URL
- When toggled OFF: deletes missingReceipts param from URL
- Deletes cursor param when filter changes (reset pagination)
- Uses router.push with { scroll: false }
- Label text: "Missing receipts only"
- Switch id: "missing-receipts" (for label association)

Follow the exact pattern from RESEARCH.md > Code Examples > Missing Receipts Toggle.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify Switch component usage:

```bash
grep -n "Switch\|missingReceipts\|onCheckedChange" components/transactions/MissingReceiptsToggle.tsx
```

  </verify>
  <done>
- MissingReceiptsToggle.tsx exists with Switch and Label imports
- Component reads missingReceipts searchParam (true/false)
- onCheckedChange updates URL (sets 'true' or deletes param)
- Label properly associated with switch via htmlFor
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Debounced Search Component</name>
  <files>components/transactions/TransactionSearch.tsx</files>
  <action>
Create TransactionSearch.tsx as a client component that:
- Uses local state (useState) for immediate input feedback
- Initializes local state from searchParams.get('search') on mount
- Implements 300ms debounced effect using useEffect + setTimeout
- When user stops typing for 300ms: updates URL searchParams.set('search', trimmedValue)
- If search input is empty: deletes search param from URL
- Deletes cursor param when search changes (reset pagination)
- Uses router.push with { scroll: false }
- Returns cleanup function in useEffect to clear timeout
- Uses Input component from @/components/ui/input
- Placeholder text: "Search vendor or description..."
- Input has search icon (magnifying glass from lucide-react)

Follow the exact pattern from RESEARCH.md > Pattern 2: Debounced Search with URL Sync.
Critical: Include timer cleanup to prevent memory leaks and stale closures.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify debounce implementation:

```bash
grep -n "setTimeout\|clearTimeout\|useEffect.*localValue" components/transactions/TransactionSearch.tsx
```

  </verify>
  <done>
- TransactionSearch.tsx exists with useState for localValue
- useEffect implements 300ms debounce with setTimeout
- Cleanup function returns clearTimeout to prevent memory leaks
- Updates URL search param when debounce fires
- Deletes search param if input is empty
  </done>
</task>

<task type="auto">
  <name>Task 5: Create Filter Chips Component</name>
  <files>components/transactions/FilterChips.tsx</files>
  <action>
Create FilterChips.tsx as a client component that:
- Accepts filters array prop: Array<{ key: string; label: string; value: string }>
- Accepts onRemove callback: (key: string) => void
- Accepts onClearAll callback: () => void
- Returns null if filters.length === 0 (don't show empty state)
- Maps over filters to render Badge components with:
  - variant="secondary"
  - Text: "{label}: {value}"
  - X button that calls onRemove(filter.key)
  - X icon from lucide-react with hover:bg-gray-300 rounded-full style
- Shows "Clear all" button if filters.length > 1 (text-sm, gray, underline, calls onClearAll)
- Uses flex-wrap layout with gap-2 for responsive chip wrapping

Follow the exact pattern from RESEARCH.md > Pattern 4: Filter Chips with Array Filtering.
Use Badge component from @/components/ui/badge.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify props and structure:

```bash
grep -n "interface FilterChipsProps\|onRemove\|onClearAll" components/transactions/FilterChips.tsx
```

  </verify>
  <done>
- FilterChips.tsx exists with FilterChipsProps interface
- Component accepts filters, onRemove, onClearAll props
- Returns null when no filters active
- Renders Badge for each filter with X button
- Shows "Clear all" button when multiple filters active
  </done>
</task>

<task type="auto">
  <name>Task 6: Integrate Filter Controls into Association Transactions Page</name>
  <files>app/association/[associationId]/transactions/page.tsx</files>
  <action>
Modify the association transactions page to integrate all filter components:

1. Import new components:
   - DateRangeFilter
   - MissingReceiptsToggle
   - TransactionSearch
   - FilterChips

2. Add filter controls in horizontal row ABOVE existing TeamFilter:
   - Layout: flex flex-wrap gap-4 items-end
   - Order: TeamFilter | DateRangeFilter | MissingReceiptsToggle | TransactionSearch
   - Each control wrapped in div with label if needed (maintain consistent spacing)

3. Derive active filters array from searchParams:
   - If dateFrom/dateTo exist: add chip with label "Date range", value "MMM d - MMM d, yyyy"
   - If missingReceipts === 'true': add chip with label "Filter", value "Missing receipts only"
   - If search exists: add chip with label "Search", value "{search text}"
   - TeamFilter already shows selected teams as badges - don't duplicate in chips

4. Add FilterChips component BELOW filter controls row (above table):
   - onRemove handler: parse key, delete corresponding searchParams, router.push
   - onClearAll handler: create fresh URLSearchParams, keep only teamIds if present, router.push

5. Update useEffect that fetches transactions to read new filter params:
   - Add dateFrom, dateTo, missingReceipts, search to URLSearchParams before fetch
   - These are now supported by API (Task 1)

6. Reset cursor to undefined when filters change (existing pattern)

Preserve all existing functionality: TeamFilter integration, drawer, cursor pagination, table display.
Follow URL state pattern: searchParams is source of truth, components update URL, useEffect reacts.
</action>
<verify>
Page compiles without errors:

```bash
npx tsc --noEmit
```

Verify imports and filter integration:

```bash
grep -n "DateRangeFilter\|MissingReceiptsToggle\|TransactionSearch\|FilterChips" app/association/[associationId]/transactions/page.tsx
```

Verify useEffect includes all filter params in fetch:

```bash
grep -A 15 "useEffect.*fetchTransactions" app/association/[associationId]/transactions/page.tsx | grep -E "dateFrom|dateTo|missingReceipts|search"
```

  </verify>
  <done>
- All filter components imported (DateRangeFilter, MissingReceiptsToggle, TransactionSearch, FilterChips)
- Filter controls row added above TeamFilter with flex layout
- FilterChips component integrated with derived active filters array
- onRemove and onClearAll handlers update URL correctly
- useEffect fetches transactions with all filter params (dateFrom, dateTo, missingReceipts, search)
- Cursor pagination reset when filters change
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Start dev server and navigate to association transactions page
2. Verify API supports new filters: test manually with curl commands from Task 1
3. Verify each filter control appears in horizontal row above table
4. Test date range picker: select range, verify URL updates with dateFrom/dateTo params
5. Test missing receipts toggle: enable, verify URL updates with missingReceipts=true
6. Test search input: type vendor name, wait 300ms, verify URL updates with search param
7. Verify filter chips appear below controls showing active filters
8. Test chip removal: click X on chip, verify filter removed and URL updated
9. Test "Clear all" button: verify all filters removed except TeamFilter selection
10. Verify browser back/forward buttons restore filter state correctly
11. Copy URL with filters applied, paste in new tab, verify filters restored
    </verification>

<success_criteria>

- API route supports dateFrom, dateTo, missingReceipts query parameters
- Date range filter functional with presets and calendar picker
- Missing receipts toggle functional with URL sync
- Search input debounced (300ms) and updates URL
- Filter chips display for all active filters (except team badges)
- Chip removal works correctly (removes individual filter)
- Clear all removes all filters except team selection
- URL state is shareable and bookmarkable
- Browser back/forward navigation preserves filter state
- Transaction list updates when filters change
- All filters work in combination (date + missing receipts + search)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-filtering-pdf-support/03-01-SUMMARY.md`
</output>
