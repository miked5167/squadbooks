---
phase: 03-enhanced-filtering-pdf-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/transactions/route.ts
  - components/transactions/DateRangeFilter.tsx
  - components/transactions/MissingReceiptsToggle.tsx
  - components/transactions/TransactionSearch.tsx
autonomous: true

must_haves:
  truths:
    - 'Association user can filter transactions by date range using from/to date pickers'
    - "Association user can toggle 'missing receipts only' filter to show transactions without receipts"
    - 'Association user can search transactions by vendor name or description with debounced input'
  artifacts:
    - path: 'app/api/transactions/route.ts'
      provides: 'API supports dateFrom, dateTo, missingReceipts query params'
      exports: ['GET']
      contains: 'dateFrom.*dateTo.*missingReceipts'
    - path: 'components/transactions/DateRangeFilter.tsx'
      provides: 'Date range picker with presets (Last 7/30 days, This month)'
      min_lines: 80
    - path: 'components/transactions/MissingReceiptsToggle.tsx'
      provides: 'Toggle switch for missing receipts filter'
      min_lines: 30
    - path: 'components/transactions/TransactionSearch.tsx'
      provides: 'Debounced search input for vendor/description'
      min_lines: 40
  key_links:
    - from: 'app/api/transactions/route.ts'
      to: 'prisma.transaction.findMany'
      via: 'where clause with transactionDate and receiptUrl filters'
      pattern: 'transactionDate.*gte|lte|receiptUrl.*null'
    - from: 'components/transactions/DateRangeFilter.tsx'
      to: 'URL searchParams (dateFrom, dateTo)'
      via: 'router.push with URLSearchParams'
      pattern: "params\\.set\\('dateFrom'|'dateTo'"
    - from: 'components/transactions/TransactionSearch.tsx'
      to: 'URL searchParams (search)'
      via: 'debounced useEffect -> router.push'
      pattern: "setTimeout.*router\\.push"
---

<objective>
Add API support and core filter components (date range, missing receipts toggle, search input) with URL state persistence.

Purpose: Enable association users to filter transactions by date, receipt status, and vendor/description with individual filter controls.
Output: API route enhancements and three independent filter components ready for page integration.

Note: FILTER-01 (team multi-select) is already satisfied by existing TeamFilter.tsx component from Phase 2. This plan adds date, missing receipts, and search filters.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-CONTEXT.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-RESEARCH.md
@.planning/phases/02-association-dashboard-view/02-01-SUMMARY.md

# Existing patterns to extend

@components/transactions/TeamFilter.tsx
@app/association/[associationId]/transactions/page.tsx
@app/api/transactions/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance API Route to Support Date and Receipt Filters</name>
  <files>app/api/transactions/route.ts</files>
  <action>
Modify /api/transactions GET handler to support dateFrom, dateTo, and missingReceipts query parameters:

1. Parse new query params after existing params (line ~48):
   - dateFrom: ISO date string (YYYY-MM-DD)
   - dateTo: ISO date string (YYYY-MM-DD)
   - missingReceipts: 'true' | 'false' (boolean string)

2. Add to filters object type definition:

   ```typescript
   const filters: {
     // ... existing filters
     dateFrom?: string
     dateTo?: string
     missingReceipts?: boolean
   } = {}
   ```

3. Parse and validate date parameters:

   ```typescript
   const dateFromParam = searchParams.get('dateFrom')
   const dateToParam = searchParams.get('dateTo')
   const missingReceiptsParam = searchParams.get('missingReceipts')

   if (dateFromParam) {
     filters.dateFrom = dateFromParam // Will be converted to Date in getTransactionsWithCursor
   }
   if (dateToParam) {
     filters.dateTo = dateToParam
   }
   if (missingReceiptsParam === 'true') {
     filters.missingReceipts = true
   }
   ```

4. Update getTransactionsWithCursor function in lib/db/transactions.ts to handle new filters:
   - Add dateFrom/dateTo to where clause: `transactionDate: { gte: new Date(filters.dateFrom), lte: new Date(filters.dateTo) }`
   - Add missingReceipts to where clause: `receiptUrl: filters.missingReceipts ? null : undefined`
   - Only apply date filters if both dateFrom and dateTo are present (partial ranges not supported)

Existing API handles: teamIds, limit, cursor, type, status, categoryId, search.
These new filters are additive and work with existing filters.
</action>
<verify>
API compiles without errors:

```bash
npx tsc --noEmit
```

Search for new filter parsing:

```bash
grep -n "dateFrom\|dateTo\|missingReceipts" app/api/transactions/route.ts
```

Test API manually with filters:

```bash
curl "http://localhost:3000/api/transactions?dateFrom=2026-01-01&dateTo=2026-01-19&limit=5"
curl "http://localhost:3000/api/transactions?missingReceipts=true&limit=5"
```

Expected: Returns filtered transactions matching date range and/or missing receipts condition.
</verify>
<done>

- API route parses dateFrom, dateTo, missingReceipts query parameters
- filters object includes new filter types
- lib/db/transactions.ts getTransactionsWithCursor function applies date range filter (transactionDate gte/lte)
- lib/db/transactions.ts applies missing receipts filter (receiptUrl: null)
- Date strings converted to Date objects for Prisma queries
- Filters work in combination with existing filters (search, teamIds, etc.)
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create Date Range Filter Component</name>
  <files>components/transactions/DateRangeFilter.tsx</files>
  <action>
Create DateRangeFilter.tsx as a client component that:
- Uses react-day-picker in range mode with 2 months side-by-side (desktop) and 1 month (mobile)
- Includes preset buttons: "Last 7 days", "Last 30 days", "This month", "Clear"
- Reads dateFrom/dateTo from useSearchParams on mount to initialize range
- Updates URL searchParams when date range changes via router.push
- Deletes cursor param when filters change (reset pagination)
- Uses { scroll: false } to prevent page jump
- Formats dates as YYYY-MM-DD (ISO date strings, no timezone) for URL
- Uses Radix UI Popover + Button trigger with CalendarIcon
- Displays selected range in trigger button text (e.g., "Jan 15 - Feb 10, 2026" or "Select date range")

Follow the exact pattern from RESEARCH.md > Code Examples > Date Range Filter with Presets.
Use date-fns functions: format, subDays, startOfMonth, endOfMonth.
Import Calendar from @/components/ui/calendar (uses react-day-picker).
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Search for key patterns:

```bash
grep -n "useSearchParams\|router.push\|dateFrom\|dateTo" components/transactions/DateRangeFilter.tsx
```

  </verify>
  <done>
- DateRangeFilter.tsx exists with DateRange import from react-day-picker
- Component reads/writes dateFrom and dateTo searchParams
- Preset buttons included (Last 7/30 days, This month, Clear)
- Uses Popover + Calendar with range mode and 2 months display
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Missing Receipts Toggle Component</name>
  <files>components/transactions/MissingReceiptsToggle.tsx</files>
  <action>
Create MissingReceiptsToggle.tsx as a client component that:
- Uses Radix UI Switch component with Label
- Reads missingReceipts param from useSearchParams (checked if value is 'true')
- When toggled ON: sets missingReceits=true in URL
- When toggled OFF: deletes missingReceipts param from URL
- Deletes cursor param when filter changes (reset pagination)
- Uses router.push with { scroll: false }
- Label text: "Missing receipts only"
- Switch id: "missing-receipts" (for label association)

Follow the exact pattern from RESEARCH.md > Code Examples > Missing Receipts Toggle.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify Switch component usage:

```bash
grep -n "Switch\|missingReceipts\|onCheckedChange" components/transactions/MissingReceiptsToggle.tsx
```

  </verify>
  <done>
- MissingReceiptsToggle.tsx exists with Switch and Label imports
- Component reads missingReceipts searchParam (true/false)
- onCheckedChange updates URL (sets 'true' or deletes param)
- Label properly associated with switch via htmlFor
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Debounced Search Component</name>
  <files>components/transactions/TransactionSearch.tsx</files>
  <action>
Create TransactionSearch.tsx as a client component that:
- Uses local state (useState) for immediate input feedback
- Initializes local state from searchParams.get('search') on mount
- Implements 300ms debounced effect using useEffect + setTimeout
- When user stops typing for 300ms: updates URL searchParams.set('search', trimmedValue)
- If search input is empty: deletes search param from URL
- Deletes cursor param when search changes (reset pagination)
- Uses router.push with { scroll: false }
- Returns cleanup function in useEffect to clear timeout
- Uses Input component from @/components/ui/input
- Placeholder text: "Search vendor or description..."
- Input has search icon (magnifying glass from lucide-react)

Follow the exact pattern from RESEARCH.md > Pattern 2: Debounced Search with URL Sync.
Critical: Include timer cleanup to prevent memory leaks and stale closures.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify debounce implementation:

```bash
grep -n "setTimeout\|clearTimeout\|useEffect.*localValue" components/transactions/TransactionSearch.tsx
```

  </verify>
  <done>
- TransactionSearch.tsx exists with useState for localValue
- useEffect implements 300ms debounce with setTimeout
- Cleanup function returns clearTimeout to prevent memory leaks
- Updates URL search param when debounce fires
- Deletes search param if input is empty
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Start dev server and navigate to association transactions page
2. Verify API supports new filters: test manually with curl commands from Task 1
3. Verify date range component can be imported (no compilation errors)
4. Verify missing receipts toggle component can be imported (no compilation errors)
5. Verify search component can be imported (no compilation errors)
6. All components will be integrated in next plan (03-02)
   </verification>

<success_criteria>

- API route supports dateFrom, dateTo, missingReceipts query parameters
- Date range filter component created with calendar picker and presets
- Missing receipts toggle component created with URL sync
- Search input component created with 300ms debounce
- All components compile without errors
- All components ready for integration into page
  </success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-filtering-pdf-support/03-01-SUMMARY.md`
</output>
