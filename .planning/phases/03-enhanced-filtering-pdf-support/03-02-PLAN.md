---
phase: 03-enhanced-filtering-pdf-support
plan: 02
type: execute
wave: 2
depends_on: ['03-01']
files_modified:
  - app/api/transactions/route.ts
  - app/association/[associationId]/transactions/page.tsx
  - components/dashboard/TransactionsPreviewTable.tsx
autonomous: true

must_haves:
  truths:
    - 'Association user can click column header (Date, Amount, Category, Vendor) to sort transactions'
    - 'Clicking same column header toggles between ascending and descending order'
    - 'Active sort shows visual indicator (up/down arrow) next to column name'
    - 'Sort state persists in URL (sortBy and sortDir parameters)'
    - 'Sorting works in combination with other filters (date range, search, missing receipts)'
  artifacts:
    - path: 'app/api/transactions/route.ts'
      provides: 'Transaction query supports orderBy based on sortBy/sortDir params'
      exports: ['GET']
      contains: 'orderBy.*sortBy.*sortDir'
    - path: 'app/association/[associationId]/transactions/page.tsx'
      provides: 'Sortable column headers with click handlers and sort indicators'
      exports: ['default']
    - path: 'components/dashboard/TransactionsPreviewTable.tsx'
      provides: 'Sortable table headers (if association user context)'
      exports: ['TransactionsPreviewTable']
  key_links:
    - from: 'app/association/[associationId]/transactions/page.tsx'
      to: 'URL searchParams (sortBy, sortDir)'
      via: 'handleSort -> router.push'
      pattern: "params\\.set\\('sortBy'|'sortDir'"
    - from: 'app/association/[associationId]/transactions/page.tsx'
      to: '/api/transactions'
      via: 'useEffect includes sortBy/sortDir in fetch params'
      pattern: "searchParams\\.get\\('sortBy'\\)"
    - from: 'app/api/transactions/route.ts'
      to: 'prisma.transaction.findMany'
      via: 'orderBy clause derived from sortBy/sortDir'
      pattern: 'orderBy:.*transactionDate|amount|category|vendor'
---

<objective>
Add column sorting capability to association transaction tables with URL-driven state and visual sort indicators.

Purpose: Enable association users to quickly analyze transactions by sorting on key dimensions (chronological, financial, categorical).
Output: Clickable column headers that toggle sort order, update URL, and persist sort state across navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-CONTEXT.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-RESEARCH.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-01-PLAN.md

# Existing code to enhance

@app/api/transactions/route.ts
@app/association/[associationId]/transactions/page.tsx
@components/dashboard/TransactionsPreviewTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance API Route to Support Sorting</name>
  <files>app/api/transactions/route.ts</files>
  <action>
Modify /api/transactions GET handler to support sortBy and sortDir query parameters:

1. Parse new query params:
   - sortBy: 'date' | 'amount' | 'category' | 'vendor' (default: 'date')
   - sortDir: 'asc' | 'desc' (default: 'desc')

2. Map sortBy values to Prisma orderBy fields:
   - 'date' -> orderBy: { transactionDate: sortDir }
   - 'amount' -> orderBy: { amount: sortDir }
   - 'category' -> orderBy: { category: { name: sortDir } } (nested relation)
   - 'vendor' -> orderBy: { vendor: sortDir }

3. Update existing orderBy logic:
   - If sortBy provided and valid: use mapped orderBy
   - Otherwise: keep existing default orderBy (likely transactionDate DESC for cursor pagination compatibility)
   - Preserve secondary sort on id for stable pagination: [{ [field]: sortDir }, { id: 'desc' }]

4. Validate sortBy/sortDir values:
   - If invalid values provided, ignore and use defaults (don't throw error)
   - Log warning for invalid sort parameters

Existing API handles: teamIds, limit, cursor, dateFrom, dateTo, missingReceipts, search.
Preserve all existing functionality - sorting is additive.
</action>
<verify>
API compiles without errors:

```bash
npx tsc --noEmit
```

Search for orderBy implementation:

```bash
grep -n "orderBy\|sortBy\|sortDir" app/api/transactions/route.ts
```

Test API manually:

```bash
curl "http://localhost:3000/api/transactions?sortBy=amount&sortDir=asc&limit=5"
```

Expected: Returns transactions sorted by amount ascending.
</verify>
<done>

- API route parses sortBy and sortDir query parameters
- Mapping from sortBy values to Prisma orderBy fields implemented
- Category sort uses nested relation orderBy: { category: { name: sortDir } }
- Invalid sort parameters handled gracefully (fallback to defaults)
- Secondary sort on id included for cursor pagination stability
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add Sortable Column Headers to Association Transactions Page</name>
  <files>app/association/[associationId]/transactions/page.tsx</files>
  <action>
Modify association transactions page to add column sorting:

1. Create useTransactionSort custom hook (inline in same file):
   - Reads sortBy and sortDir from useSearchParams
   - Defaults: sortBy='date', sortDir='desc'
   - Returns { sortBy, sortDir, handleSort }
   - handleSort(field) logic:
     - If clicking same field: toggle direction (desc -> asc -> desc)
     - If clicking new field: set field, default to desc
     - Update URL with params.set('sortBy', field) and params.set('sortDir', dir)
     - Delete cursor param (reset pagination)
     - router.push with { scroll: false }

2. Update TableHead components to be clickable:
   - Add onClick handlers for: Date, Vendor, Category, Amount columns
   - Add cursor-pointer and hover:bg-gray-100 classes
   - Add sort indicator (↑ or ↓) when column is active sort:
     ```tsx
     {
       sortBy === 'date' && <span className="ml-1">{sortDir === 'asc' ? '↑' : '↓'}</span>
     }
     ```
   - Position indicator inline after column text

3. Update useEffect that fetches transactions:
   - Read sortBy and sortDir from searchParams
   - Add to URLSearchParams before fetch: params.append('sortBy', sortBy) and params.append('sortDir', sortDir)

4. Add sortBy and sortDir to useEffect dependency array if not already watching all searchParams

Follow pattern from RESEARCH.md > Code Examples > Column Sort Integration.
</action>
<verify>
Page compiles without errors:

```bash
npx tsc --noEmit
```

Verify sort hook and handlers:

```bash
grep -n "useTransactionSort\|handleSort\|sortBy\|sortDir" app/association/[associationId]/transactions/page.tsx
```

Verify TableHead has onClick handlers:

```bash
grep -n "onClick.*handleSort" app/association/[associationId]/transactions/page.tsx
```

  </verify>
  <done>
- useTransactionSort hook created with handleSort function
- All sortable column headers have onClick handlers
- Sort indicators (↑/↓) display next to active column
- Clicking column toggles sort direction for same column
- Clicking new column switches sort field and defaults to descending
- URL updates with sortBy and sortDir parameters
- useEffect fetches transactions with sort parameters
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Optional Sorting to Dashboard Transactions Preview Table</name>
  <files>components/dashboard/TransactionsPreviewTable.tsx</files>
  <action>
Enhance TransactionsPreviewTable component to support optional sorting for association users:

1. Add optional props to component interface:
   - isAssociationUser?: boolean (default false)
   - If not provided or false: table headers remain non-interactive (current behavior)

2. If isAssociationUser === true:
   - Implement same useTransactionSort hook pattern as association transactions page
   - Make column headers clickable with sort indicators
   - Update URL with sortBy/sortDir params
   - Component likely already fetches from /api/transactions - ensure sort params included

3. If isAssociationUser === false or undefined:
   - Keep existing non-sortable headers
   - No behavioral changes

This allows dashboard to show sortable transactions for association users while preserving current behavior for team treasurers.

Note: Check if TransactionsPreviewTable is actually used by association users on dashboard. If dashboard page at /association/[id]/dashboard doesn't exist yet, this task can add sorting capability but won't be visible until dashboard is built. Implement the capability regardless.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify conditional sorting logic:

```bash
grep -n "isAssociationUser\|useTransactionSort" components/dashboard/TransactionsPreviewTable.tsx
```

Check if component is used in association context:

```bash
grep -r "TransactionsPreviewTable" app/association/
```

  </verify>
  <done>
- TransactionsPreviewTable accepts optional isAssociationUser prop
- When isAssociationUser=true: column headers are sortable with indicators
- When isAssociationUser=false/undefined: headers remain non-interactive
- Sort state updates URL and triggers re-fetch if applicable
- Existing behavior preserved for team treasurer context
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Start dev server and navigate to association transactions page
2. Verify column headers show hover state (cursor-pointer, bg change)
3. Click "Date" header: verify sort indicator appears (↓ for desc)
4. Click "Date" again: verify indicator flips (↑ for asc)
5. Click "Amount" header: verify sort switches to amount column (↓)
6. Verify URL updates with sortBy=amount&sortDir=desc
7. Verify transactions reorder correctly (highest amount first for desc)
8. Test sort combined with filters:
   - Apply date range filter
   - Apply search filter
   - Change sort to "Category" ascending
   - Verify all filters + sort work together
9. Copy URL with sort params, paste in new tab, verify sort state restored
10. Click browser back button, verify previous sort state restored
11. Test "Vendor" column sort (alphabetical order)
    </verification>

<success_criteria>

- API route accepts and processes sortBy/sortDir parameters
- Column headers clickable on association transactions page
- Sort indicators (↑/↓) display correctly for active column
- Clicking column toggles sort direction (desc ↔ asc)
- URL updates with sortBy and sortDir parameters
- Transactions reorder correctly based on sort selection
- Sort works in combination with all other filters
- Sort state persists in URL (shareable/bookmarkable)
- Browser back/forward navigation preserves sort state
- Dashboard preview table optionally supports sorting for association users
  </success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-filtering-pdf-support/03-02-SUMMARY.md`
</output>
