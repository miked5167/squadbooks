---
phase: 03-enhanced-filtering-pdf-support
plan: 04
type: execute
wave: 2
depends_on: ['01']
files_modified:
  - components/ReceiptViewer.tsx
  - package.json
autonomous: true

user_setup:
  - service: react-pdf
    why: 'Enhanced PDF viewing with page navigation'
    npm_install: 'react-pdf'
    note: 'Installed automatically via npm install react-pdf during task execution'

must_haves:
  truths:
    - 'Association user can view PDF receipts with page-by-page rendering (not all pages at once)'
    - 'Association user can navigate between pages using prev/next buttons'
    - "Association user can see current page number and total pages (e.g., 'Page 2 of 5')"
    - 'Association user can zoom in/out with zoom controls (0.5x to 3.0x)'
    - 'Association user can download PDF receipt from viewer'
    - 'PDF viewer shows receipt metadata (transaction amount, vendor, upload date)'
  artifacts:
    - path: 'components/ReceiptViewer.tsx'
      provides: 'Enhanced PDF viewer with react-pdf Document/Page components'
      exports: ['ReceiptViewer']
      min_lines: 200
      contains: 'react-pdf.*Document.*Page'
    - path: 'package.json'
      provides: 'react-pdf dependency added'
      contains: 'react-pdf'
  key_links:
    - from: 'components/ReceiptViewer.tsx'
      to: 'react-pdf Document component'
      via: 'pdfjs.GlobalWorkerOptions.workerSrc configured before render'
      pattern: "pdfjs\\.GlobalWorkerOptions\\.workerSrc"
    - from: 'components/ReceiptViewer.tsx'
      to: 'Page navigation state'
      via: 'useState for pageNumber, numPages, scale'
      pattern: 'useState.*pageNumber|numPages|scale'
    - from: 'components/ReceiptViewer.tsx'
      to: 'Zoom controls'
      via: 'ZoomIn/ZoomOut buttons update scale state'
      pattern: "setScale.*Math\\.min|Math\\.max"
---

<objective>
Replace basic iframe PDF viewing with enhanced react-pdf viewer featuring page navigation, zoom controls, and receipt metadata display.

Purpose: Enable association users to effectively review multi-page PDF receipts with professional viewing controls.
Output: Fully functional PDF viewer with navigation, zoom, metadata, and download capabilities.

Note: Independent from filtering plans - enhances receipt viewing experience regardless of how users find transactions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-CONTEXT.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-RESEARCH.md

# Existing code to enhance

@components/ReceiptViewer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-pdf Dependency</name>
  <files>package.json</files>
  <action>
Install react-pdf library for enhanced PDF viewing:

```bash
npm install react-pdf
```

This adds react-pdf to dependencies in package.json.
The library provides Document and Page components for PDF rendering with pdfjs worker support.

Note: Do NOT install @react-pdf/renderer (that's for PDF generation, not viewing).
We need wojtekmaj/react-pdf for viewing.
</action>
<verify>
Verify installation:

```bash
grep "react-pdf" package.json
```

Expected: "react-pdf": "^X.X.X" in dependencies section

Verify no errors:

```bash
npm ls react-pdf
```

Expected: Shows installed version without errors
</verify>
<done>

- react-pdf added to package.json dependencies
- npm install completed successfully
- Package available for import in components
  </done>
  </task>

<task type="auto">
  <name>Task 2: Enhance ReceiptViewer with react-pdf Integration</name>
  <files>components/ReceiptViewer.tsx</files>
  <action>
Replace the existing ReceiptViewer component to use react-pdf for PDF viewing:

1. Add imports:

   ```tsx
   import { Document, Page, pdfjs } from 'react-pdf'
   import 'react-pdf/dist/esm/Page/AnnotationLayer.css'
   import 'react-pdf/dist/esm/Page/TextLayer.css'
   import { ChevronLeft, ChevronRight, ZoomIn, ZoomOut, Download } from 'lucide-react'
   ```

2. Configure PDF.js worker at module level (before component):

   ```tsx
   pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.js`
   ```

3. Add state for PDF navigation and zoom:

   ```tsx
   const [numPages, setNumPages] = useState<number>(0)
   const [pageNumber, setPageNumber] = useState(1)
   const [scale, setScale] = useState(1.0)
   ```

4. Keep existing state: loading, error, zoom (rename zoom to scale for consistency)

5. Update PDF rendering section:
   - Replace iframe with Document + Page components
   - Document file prop: receiptUrl
   - Document onLoadSuccess: ({ numPages }) => setNumPages(numPages)
   - Page pageNumber prop: pageNumber (render only current page, not all pages)
   - Page scale prop: scale
   - Page renderTextLayer: true (enables text selection/copy)
   - Page renderAnnotationLayer: true (enables PDF links)

6. Add page navigation toolbar (between existing header and content):
   - Previous page button (disabled if pageNumber === 1)
   - Current page indicator: "Page {pageNumber} of {numPages || '...'}"
   - Next page button (disabled if pageNumber >= numPages)
   - Buttons use ChevronLeft/ChevronRight icons
   - onClick: setPageNumber(p => p - 1) and setPageNumber(p => p + 1)

7. Update zoom controls to use scale state:
   - Zoom in: setScale(s => Math.min(3.0, s + 0.25))
   - Zoom out: setScale(s => Math.max(0.5, s - 0.25))
   - Display: {Math.round(scale \* 100)}%
   - Disable zoom in at 3.0x, disable zoom out at 0.5x

8. Add metadata section (if transactionVendor, transactionAmount props available):
   - Display vendor name
   - Display transaction amount
   - Display upload date (if available via new prop)
   - Position: Above PDF viewer or in collapsible section

9. Preserve existing image viewing for JPG/PNG/WEBP files:
   - Keep getFileType() logic
   - If fileType === 'image': render img with zoom transform (existing code)
   - If fileType === 'pdf': render Document/Page (new code)

10. Keep existing toolbar with Download and Print buttons
    - Download: window.open(receiptUrl, '\_blank')
    - Print: Open PDF in new window, trigger print dialog

Follow exact pattern from RESEARCH.md > Code Examples > Enhanced PDF Viewer with Navigation.
</action>
<verify>
Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify react-pdf imports and usage:

```bash
grep -n "import.*react-pdf\|Document\|Page\|pdfjs.GlobalWorkerOptions" components/ReceiptViewer.tsx
```

Verify state management:

```bash
grep -n "useState.*numPages\|pageNumber\|scale" components/ReceiptViewer.tsx
```

Start dev server and test:

1. Open transaction with PDF receipt
2. Verify PDF renders (only current page, not all pages)
3. Verify page navigation buttons work
4. Verify zoom controls work
5. Verify download button works
   </verify>
   <done>

- react-pdf Document and Page components imported
- pdfjs.GlobalWorkerOptions.workerSrc configured with unpkg.com CDN
- State added: numPages, pageNumber, scale
- PDF section uses Document/Page instead of iframe
- Page navigation toolbar added with prev/next buttons and page indicator
- Zoom controls updated to use scale state (0.5x to 3.0x range)
- Download and print buttons preserved
- Image viewing for JPG/PNG files preserved
- Only current page rendered (not all pages at once)
  </done>
  </task>

</tasks>

<verification>
After all tasks complete:

1. Start dev server and navigate to any transaction with a PDF receipt
2. Verify PDF viewer opens in Dialog
3. Verify PDF renders correctly (first page visible)
4. Test page navigation:
   - Click next page button: verify page 2 displays
   - Click previous page button: verify page 1 displays
   - Verify buttons disable at boundaries (page 1: prev disabled, last page: next disabled)
5. Verify page indicator shows "Page X of Y" correctly
6. Test zoom controls:
   - Click zoom in: verify PDF scales up (text becomes larger)
   - Click zoom out: verify PDF scales down
   - Verify zoom percentage displays correctly (e.g., "125%")
   - Verify zoom in disabled at 300%, zoom out disabled at 50%
7. Test download button: verify PDF downloads correctly
8. Test with multi-page PDF (3+ pages): verify all pages accessible
9. Test with single-page PDF: verify navigation buttons handled correctly
10. Test with image receipt (JPG/PNG): verify existing image viewer still works
11. Verify no console errors related to PDF.js worker
    </verification>

<success_criteria>

- react-pdf installed successfully in package.json
- ReceiptViewer uses Document and Page components for PDF rendering
- PDF.js worker configured correctly (no worker-related console errors)
- Page navigation functional with prev/next buttons
- Current page indicator displays "Page X of Y"
- Zoom controls functional (0.5x to 3.0x range)
- Zoom percentage displays correctly
- Download button works for PDF receipts
- Only current page renders (not all pages at once for memory efficiency)
- Image receipts still work with existing image viewer
- No performance issues with multi-page PDFs (tested up to 10 pages)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-filtering-pdf-support/03-04-SUMMARY.md`
</output>
