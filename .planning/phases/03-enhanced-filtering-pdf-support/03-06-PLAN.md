---
phase: 03-enhanced-filtering-pdf-support
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - components/ReceiptViewer.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'Association user can view PDF receipts with page-by-page rendering (not all pages at once)'
    - 'Association user can navigate between pages using prev/next buttons'
    - "Association user can see current page number and total pages (e.g., 'Page 2 of 5')"
    - 'Association user can zoom PDFs (zoom controls enabled for PDF file type)'
  artifacts:
    - path: 'components/ReceiptViewer.tsx'
      provides: 'Enhanced PDF viewer with react-pdf Document/Page components'
      exports: ['ReceiptViewer']
      contains: 'react-pdf.*Document.*Page'
  key_links:
    - from: 'components/ReceiptViewer.tsx'
      to: 'react-pdf Document component'
      via: 'pdfjs.GlobalWorkerOptions.workerSrc configured before render'
      pattern: "pdfjs\\.GlobalWorkerOptions\\.workerSrc"
    - from: 'components/ReceiptViewer.tsx'
      to: 'Page navigation state'
      via: 'useState for pageNumber, numPages'
      pattern: 'useState.*pageNumber|numPages'
    - from: 'components/ReceiptViewer.tsx'
      to: 'Zoom controls'
      via: 'ZoomIn/ZoomOut buttons update scale state for PDFs'
      pattern: 'canZoomIn.*pdf|canZoomOut.*pdf'
---

<objective>
Replace iframe PDF viewing with react-pdf Document/Page components to enable page-by-page rendering, navigation controls, and zoom functionality for PDF receipts.

Purpose: Close verification gap - Plan 03-04 was marked complete but PDF viewer was never enhanced with react-pdf. Current implementation uses iframe which prevents page navigation and zoom controls.
Output: Fully functional PDF viewer with page navigation, zoom controls, and page indicators.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-CONTEXT.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-RESEARCH.md
@.planning/phases/03-enhanced-filtering-pdf-support/03-VERIFICATION.md

# Existing code to enhance

@components/ReceiptViewer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement react-pdf Integration in ReceiptViewer</name>
  <files>components/ReceiptViewer.tsx</files>
  <action>
Enhance ReceiptViewer.tsx to use react-pdf for PDF viewing. The component already has react-pdf@10.3.0 installed (package.json line 96) but doesn't use it.

**Gap context from VERIFICATION.md:**

- Lines 150-167 currently use iframe for PDF display
- Missing: react-pdf imports, Document/Page components, page navigation UI, worker config
- zoom controls disabled for PDFs (lines 44-45: `fileType === 'image'` restriction)

**Changes needed:**

1. Add react-pdf imports at top of file:

   ```tsx
   import { Document, Page, pdfjs } from 'react-pdf'
   import 'react-pdf/dist/esm/Page/AnnotationLayer.css'
   import 'react-pdf/dist/esm/Page/TextLayer.css'
   import { ChevronLeft, ChevronRight } from 'lucide-react'
   ```

2. Configure PDF.js worker BEFORE component definition (module level):

   ```tsx
   pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`
   ```

   NOTE: Use .min.mjs extension (not .min.js) to avoid CORS issues in Next.js

3. Add state for PDF navigation inside component (after existing `scale`, `loading`, `error` state):

   ```tsx
   const [numPages, setNumPages] = useState<number>(0)
   const [pageNumber, setPageNumber] = useState(1)
   ```

4. Update zoom control logic to work for both images AND PDFs (lines 44-45):

   ```tsx
   const canZoomIn = scale < 3.0 // Remove fileType === 'image' restriction
   const canZoomOut = scale > 0.5 // Remove fileType === 'image' restriction
   ```

5. Add page navigation toolbar AFTER existing toolbar section (around line 110):

   ```tsx
   {
     fileType === 'pdf' && (
       <div className="flex items-center gap-4 border-b bg-white px-6 py-3">
         <Button
           size="sm"
           variant="outline"
           onClick={() => setPageNumber(p => Math.max(1, p - 1))}
           disabled={pageNumber <= 1}
         >
           <ChevronLeft className="h-4 w-4" />
           Previous
         </Button>

         <span className="text-sm text-gray-600">
           Page {pageNumber} of {numPages || '...'}
         </span>

         <Button
           size="sm"
           variant="outline"
           onClick={() => setPageNumber(p => Math.min(numPages, p + 1))}
           disabled={pageNumber >= numPages}
         >
           Next
           <ChevronRight className="h-4 w-4" />
         </Button>
       </div>
     )
   }
   ```

6. Replace iframe section (lines 150-167) with react-pdf Document/Page:

   ```tsx
   {
     fileType === 'pdf' && (
       <div className="flex items-center justify-center overflow-auto bg-gray-100 p-4">
         <Document
           file={receiptUrl}
           onLoadSuccess={({ numPages }) => {
             setNumPages(numPages)
             setPageNumber(1)
             setLoading(false)
             setError(false)
           }}
           onLoadError={error => {
             console.error('PDF load error:', error)
             setLoading(false)
             setError(true)
           }}
           loading={
             <div className="flex items-center justify-center p-8">
               <Loader2 className="h-8 w-8 animate-spin" />
             </div>
           }
         >
           <Page
             pageNumber={pageNumber}
             scale={scale}
             renderTextLayer={true}
             renderAnnotationLayer={true}
             className="shadow-lg"
           />
         </Document>
       </div>
     )
   }
   ```

7. Preserve all existing functionality:
   - Keep existing image viewer code (lines 127-148)
   - Keep Download button (lines 67-74)
   - Keep Print button (lines 75-84)
   - Keep zoom controls (lines 85-109)
   - Keep loading/error states

**Why iframe was inadequate:**

- Shows ALL pages at once (memory inefficient for 100+ page docs)
- No programmatic page navigation
- No zoom control
- No page count indicator
- Research (RESEARCH.md) recommended react-pdf for these exact reasons

**Why react-pdf was chosen:**

- 7K+ GitHub stars, active maintenance
- Clean React API with Document/Page components
- Worker setup handled automatically
- Supports text selection, annotations, links
- Memory efficient (renders only current page)
- Per decision table (STATE.md line 74): "Use react-pdf instead of PDF.js direct integration"
  </action>
  <verify>
  Component compiles without errors:

```bash
npx tsc --noEmit
```

Verify react-pdf imports:

```bash
grep -n "import.*react-pdf\|pdfjs.GlobalWorkerOptions" components/ReceiptViewer.tsx
```

Verify state management:

```bash
grep -n "useState.*numPages\|pageNumber" components/ReceiptViewer.tsx
```

Verify Document/Page usage:

```bash
grep -n "Document\|Page\|onLoadSuccess" components/ReceiptViewer.tsx
```

Start dev server and test PDF viewing:

1. Open transaction with PDF receipt
2. Verify PDF renders (first page only, not all pages)
3. Verify page navigation buttons appear and work
4. Verify page indicator shows "Page X of Y"
5. Verify zoom controls work for PDFs
6. Verify no console errors about PDF.js worker
   </verify>
   <done>

- react-pdf Document and Page components imported
- pdfjs.GlobalWorkerOptions.workerSrc configured at module level with .min.mjs extension
- State added: numPages (number), pageNumber (number, starts at 1)
- canZoomIn/canZoomOut work for both images AND PDFs (no fileType restriction)
- Page navigation toolbar added with ChevronLeft/ChevronRight buttons and page indicator
- iframe replaced with Document/Page components (lines 150-167)
- Document onLoadSuccess captures numPages and resets to page 1
- Page component renders only current page with scale prop
- renderTextLayer and renderAnnotationLayer enabled for PDF features
- All existing functionality preserved (image viewer, download, print, zoom, loading/error states)
  </done>
  </task>

</tasks>

<verification>
After task completion:

1. Start dev server: `npm run dev`
2. Navigate to association transactions page
3. Click transaction with PDF receipt to open ReceiptViewer
4. Verify PDF viewer displays:
   - First page of PDF renders correctly
   - Page navigation toolbar visible below main toolbar
   - "Page 1 of N" indicator shows total pages
   - Previous button disabled on page 1
5. Test page navigation:
   - Click Next: verify page 2 displays
   - Click Next again: verify page 3 displays
   - Click Previous: verify returns to page 2
   - Navigate to last page: verify Next button disabled
6. Test zoom controls:
   - Click Zoom In: verify PDF scales up (text larger)
   - Click Zoom Out: verify PDF scales down
   - Verify zoom percentage displays (e.g., "125%")
   - Verify zoom works at boundaries (50%, 300%)
7. Test with multi-page PDF (3+ pages):
   - Verify all pages accessible via navigation
   - Verify only current page renders (check DevTools: single canvas element, not multiple)
8. Test with single-page PDF:
   - Verify navigation buttons appear but both disabled
   - Verify shows "Page 1 of 1"
9. Test with image receipt (JPG/PNG):
   - Verify image viewer still works (no regression)
   - Verify zoom works for images
10. Verify no console errors related to PDF.js worker or CORS
11. Test download and print buttons still work for PDFs
    </verification>

<success_criteria>

- ReceiptViewer uses Document and Page components for PDF rendering (no iframe)
- PDF.js worker configured correctly (no worker-related console errors, .min.mjs extension)
- Page navigation toolbar appears for PDFs with prev/next buttons
- Page indicator displays "Page X of Y" correctly
- Only current page renders (memory efficient for large PDFs)
- Zoom controls work for BOTH PDFs and images
- Navigation buttons disable appropriately at boundaries (page 1, last page)
- Download and print buttons still work
- Image receipts still work (no regression)
- No console errors or warnings
  </success_criteria>

<output>
After completion, create `.planning/phases/03-enhanced-filtering-pdf-support/03-06-SUMMARY.md`
</output>
