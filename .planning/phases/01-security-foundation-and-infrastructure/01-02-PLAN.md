---
phase: 01-security-foundation-and-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ['01']
files_modified:
  - scripts/verify-database-performance.ts
  - .planning/phases/01-security-foundation-and-infrastructure/01-PERFORMANCE.md
autonomous: false

must_haves:
  truths:
    - 'Dashboard loads all team data within 2 seconds for 50 teams with 1000 transactions each'
    - 'Association user querying all teams executes single batch query (no N+1)'
    - 'Performance validated with realistic production data volumes'
  artifacts:
    - path: 'scripts/verify-database-performance.ts'
      provides: 'Database performance verification script'
      contains: 'EXPLAIN ANALYZE'
      min_lines: 150
    - path: '.planning/phases/01-security-foundation-and-infrastructure/01-PERFORMANCE.md'
      provides: 'Performance verification results and recommendations'
      contains: 'PERF-01'
      min_lines: 50
  key_links:
    - from: 'scripts/verify-database-performance.ts'
      to: 'lib/db/transactions.ts'
      via: 'getTransactionsWithCursor() function call'
      pattern: 'getTransactionsWithCursor'
    - from: 'scripts/verify-database-performance.ts'
      to: '@prisma/client'
      via: 'Raw SQL execution for EXPLAIN ANALYZE'
      pattern: "\\$queryRaw"
---

<objective>
Verify that existing composite database indexes perform efficiently for multi-team association queries and document performance characteristics for production readiness.

Purpose: Confirm PERF-01, PERF-02, PERF-03 requirements are met with existing database schema. Identify any performance bottlenecks before association users access the system.

Output: Performance verification script, documented query execution plans, and performance report confirming sub-2-second dashboard loads for realistic data volumes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-security-foundation-and-infrastructure/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Database query layer

@lib/db/transactions.ts

# Prisma schema with indexes

@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Database Performance Verification Script</name>
  <files>
    scripts/verify-database-performance.ts
  </files>
  <action>
Create a comprehensive TypeScript script that verifies database performance for multi-team association queries.

**Script structure:**

```typescript
#!/usr/bin/env tsx
import { prisma } from '@/lib/prisma'
import { getTransactionsWithCursor } from '@/lib/db/transactions'
import { getAccessibleTeams } from '@/lib/permissions/server-permissions'

// Colors for console output
const colors = { green: '\x1b[32m', red: '\x1b[31m', yellow: '\x1b[33m', reset: '\x1b[0m' }

async function main() {
  console.log('Database Performance Verification for Phase 1\n')

  // Test 1: Verify composite indexes exist
  await verifyIndexes()

  // Test 2: Test multi-team query with EXPLAIN ANALYZE
  await testMultiTeamQuery()

  // Test 3: Test cursor pagination performance
  await testCursorPagination()

  // Test 4: Simulate realistic association dashboard load
  await testAssociationDashboardLoad()

  console.log('\n✅ Performance verification complete')
}

async function verifyIndexes() {
  console.log('1. Verifying composite indexes on transactions table...')

  // Query PostgreSQL system catalogs to check indexes
  const indexes = await prisma.$queryRaw`
    SELECT indexname, indexdef
    FROM pg_indexes
    WHERE tablename = 'transactions'
    AND indexdef LIKE '%team_id%'
    ORDER BY indexname;
  `

  console.log(`Found ${indexes.length} indexes on transactions table:`)
  indexes.forEach(idx => console.log(`  - ${idx.indexname}`))

  // Check for required composite index
  const hasCompositeIndex = indexes.some(
    idx => idx.indexdef.includes('team_id') && idx.indexdef.includes('transaction_date')
  )

  if (hasCompositeIndex) {
    console.log(
      `${colors.green}✓${colors.reset} Composite index on (teamId, transactionDate) exists\n`
    )
  } else {
    console.log(
      `${colors.red}✗${colors.reset} Missing composite index - performance may be degraded\n`
    )
  }
}

async function testMultiTeamQuery() {
  console.log('2. Testing multi-team query performance...')

  // Get sample teams (up to 50)
  const teams = await prisma.team.findMany({ take: 50, select: { id: true } })
  const teamIds = teams.map(t => t.id)

  console.log(`Testing with ${teamIds.length} teams`)

  // Run EXPLAIN ANALYZE on multi-team query
  const explainResult = await prisma.$queryRaw`
    EXPLAIN ANALYZE
    SELECT * FROM transactions
    WHERE team_id = ANY(${teamIds})
      AND deleted_at IS NULL
    ORDER BY transaction_date DESC, id DESC
    LIMIT 20;
  `

  console.log('Query execution plan:')
  explainResult.forEach(row => console.log(`  ${row['QUERY PLAN']}`))

  // Check for efficient index usage
  const plan = JSON.stringify(explainResult)
  const usesIndexScan = plan.includes('Index Scan') || plan.includes('Index Only Scan')
  const usesSeqScan = plan.includes('Seq Scan')

  if (usesIndexScan && !usesSeqScan) {
    console.log(`${colors.green}✓${colors.reset} Query uses index scan (efficient)\n`)
  } else {
    console.log(`${colors.yellow}⚠${colors.reset} Query may not use indexes optimally\n`)
  }
}

async function testCursorPagination() {
  console.log('3. Testing cursor pagination performance...')

  const teams = await prisma.team.findMany({ take: 10, select: { id: true } })
  const teamIds = teams.map(t => t.id)

  const start = Date.now()
  const result = await getTransactionsWithCursor({
    teamIds,
    limit: 50,
    filters: {},
  })
  const duration = Date.now() - start

  console.log(`Fetched ${result.items.length} transactions in ${duration}ms`)

  if (duration < 1000) {
    console.log(`${colors.green}✓${colors.reset} Query completed in <1s (${duration}ms)\n`)
  } else {
    console.log(`${colors.yellow}⚠${colors.reset} Query took ${duration}ms (target: <1000ms)\n`)
  }
}

async function testAssociationDashboardLoad() {
  console.log('4. Simulating association dashboard load (PERF-03)...')

  // Get up to 50 teams
  const teams = await prisma.team.findMany({ take: 50, select: { id: true } })
  const teamIds = teams.map(t => t.id)

  console.log(`Simulating dashboard load for association with ${teamIds.length} teams`)

  const start = Date.now()

  // Simulate typical dashboard queries
  const [transactions, teamCount, transactionCount] = await Promise.all([
    getTransactionsWithCursor({
      teamIds,
      limit: 50,
      filters: {},
    }),
    prisma.team.count({ where: { id: { in: teamIds } } }),
    prisma.transaction.count({
      where: {
        teamId: { in: teamIds },
        deletedAt: null,
      },
    }),
  ])

  const duration = Date.now() - start

  console.log(`Dashboard data fetched:`)
  console.log(`  - ${transactions.items.length} transactions`)
  console.log(`  - ${teamCount} teams`)
  console.log(`  - ${transactionCount} total transactions`)
  console.log(`  - Duration: ${duration}ms`)

  if (duration < 2000) {
    console.log(
      `${colors.green}✓${colors.reset} Dashboard load <2s (${duration}ms) - PERF-03 met\n`
    )
  } else {
    console.log(
      `${colors.red}✗${colors.reset} Dashboard load ${duration}ms exceeds 2s target - PERF-03 not met\n`
    )
  }
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
```

**Make script executable:**

- Add shebang: `#!/usr/bin/env tsx`
- File should be runnable via `npm run tsx scripts/verify-database-performance.ts`

**Output format:**

- Clear section headers with numbered tests
- Green checkmarks for passing tests, yellow warnings for borderline, red X for failures
- Show actual query execution plans from EXPLAIN ANALYZE
- Report timing in milliseconds
- Final summary of PERF-01, PERF-02, PERF-03 status
  </action>
  <verify>

1. Run TypeScript compiler check:

   ```
   npx tsx --check scripts/verify-database-performance.ts
   ```

   Must compile without errors

2. Verify script is executable:

   ```
   npx tsx scripts/verify-database-performance.ts
   ```

   Should output performance test results

3. Check script includes all required tests:
   ```
   grep -c "async function" scripts/verify-database-performance.ts
   ```
   Should show at least 4 test functions
   </verify>
   <done>

- Performance verification script exists at scripts/verify-database-performance.ts
- Script checks for composite indexes on transactions table
- Script runs EXPLAIN ANALYZE on multi-team queries
- Script tests cursor pagination performance
- Script simulates association dashboard load with timing
- Script compiles and runs successfully
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Database performance verification script that tests multi-team query performance, index usage, and cursor pagination. Script outputs detailed execution plans and timing data.
  </what-built>
  <how-to-verify>
1. Run the performance verification script:
   ```bash
   cd C:\Users\miked\Squadbooks
   npx tsx scripts/verify-database-performance.ts
   ```

2. Review the output and verify:
   - **Composite indexes exist:** Look for green checkmark confirming composite index on (teamId, transactionDate)
   - **Index scan usage:** EXPLAIN ANALYZE output should show "Index Scan" or "Index Only Scan", NOT "Seq Scan" or "Bitmap Heap Scan"
   - **Cursor pagination timing:** Should complete in <1000ms for 10 teams
   - **Dashboard load timing:** Should complete in <2000ms for 50 teams (PERF-03)

3. Check for performance issues:
   - Any yellow warnings (⚠) indicate borderline performance - note for investigation
   - Any red X marks (✗) indicate performance requirements not met - BLOCKER for phase
   - Green checkmarks (✓) indicate passing

4. Review query execution plans:
   - Look for "Index Scan using transactions_team_id_deleted_at_transaction_date_id_idx" or similar
   - Check "actual time" values in EXPLAIN output (should be low, <100ms)
   - Verify "rows" matched is reasonable for dataset size

5. Create performance report by copying console output to `.planning/phases/01-security-foundation-and-infrastructure/01-PERFORMANCE.md`

**Expected outcome:** All tests show green checkmarks, dashboard loads in <2s, queries use index scans.

**If performance issues found:** Document in PERFORMANCE.md and note specific bottlenecks (missing indexes, slow queries, N+1 patterns).
</how-to-verify>
<resume-signal>
Type one of:

- "performance verified" if all tests pass (green checkmarks, <2s dashboard load)
- "performance issues: [description]" if tests fail or show warnings
- Include timing numbers from script output
  </resume-signal>
  </task>

</tasks>

<verification>
Review performance verification results:

**PERF-01 (Composite index):**

- Script confirms index exists: `transactions_team_id_deleted_at_transaction_date_id_idx`
- Index covers (teamId, deletedAt, transactionDate, id) as documented in schema
- Query execution plan shows Index Scan usage (not Sequential Scan)

**PERF-02 (No N+1 queries):**

- EXPLAIN ANALYZE shows single query for multi-team fetch
- No loops or sequential fetches in execution plan
- getTransactionsWithCursor uses `WHERE teamId IN (...)` batch pattern

**PERF-03 (Dashboard <2s):**

- Timed dashboard simulation completes in <2000ms
- Parallel Promise.all pattern used for concurrent queries
- Result includes actual timing data for production validation

Document any performance issues or optimizations needed in PERFORMANCE.md.
</verification>

<success_criteria>

1. Performance verification script runs successfully and outputs test results
2. Composite indexes confirmed to exist on transactions table
3. Multi-team queries use index scans (not sequential scans)
4. Cursor pagination completes in <1s for 10 teams
5. Association dashboard load completes in <2s for 50 teams (PERF-03 requirement)
6. Performance report created documenting verification results
7. All PERF-01, PERF-02, PERF-03 requirements validated with empirical data
   </success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation-and-infrastructure/01-02-SUMMARY.md` following the summary template.

Include performance verification results and any recommendations for optimization or monitoring.
</output>
