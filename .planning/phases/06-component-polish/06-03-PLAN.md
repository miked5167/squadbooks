---
phase: 06-component-polish
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - app/association/page.tsx
  - components/dashboard/TeamsNeedingAttentionWidget.tsx
autonomous: true

must_haves:
  truths:
    - Teams Needing Attention widget shows visual breakdown bar with critical vs warning distribution
    - Breakdown bar segments show proportional width based on team counts
    - Numerical counts displayed alongside visual bar (not relying on bar alone)
    - Critical teams shown in red segment with AlertOctagon icon
    - Warning teams shown in amber segment with AlertTriangle icon
    - Empty state (no teams needing attention) shows success message
    - Visual breakdown uses same colors/icons as status badges for consistency
  artifacts:
    - path: components/dashboard/TeamsNeedingAttentionWidget.tsx
      provides: Reusable breakdown widget with visual bar and team list
      min_lines: 80
      exports: ['TeamsNeedingAttentionWidget']
    - path: app/association/page.tsx
      provides: Teams Needing Attention section using TeamsNeedingAttentionWidget
      contains: 'TeamsNeedingAttentionWidget'
  key_links:
    - from: components/dashboard/TeamsNeedingAttentionWidget.tsx
      to: Status badge icons and colors
      via: import from lucide-react and tailwind classes
      pattern: 'AlertOctagon.*AlertTriangle'
    - from: Breakdown bar segments
      to: Team counts
      via: width percentage calculation
      pattern: 'width.*count.*total'
    - from: app/association/page.tsx
      to: TeamsNeedingAttentionWidget
      via: component usage with team data
      pattern: 'TeamsNeedingAttentionWidget.*teams='
---

<objective>
Create Teams Needing Attention widget with visual breakdown bar showing critical vs warning distribution

Purpose: Provide at-a-glance understanding of team status distribution using FreshBooks "Outstanding Invoices" pattern with visual breakdown and numerical counts
Output: Reusable widget component displaying stacked breakdown bar, numerical counts with color coding, and team list
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-component-polish/06-CONTEXT.md
@.planning/phases/06-component-polish/06-RESEARCH.md
@.planning/phases/06-component-polish/06-01-PLAN.md

# Association overview page (has existing Teams Needing Attention card)

@app/association/page.tsx

# For reference: Multi-segment breakdown bar pattern from research

# Pattern: Stacked segments showing distribution, legend with counts, 3-7 segments max

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TeamsNeedingAttentionWidget component with visual breakdown</name>
  <files>components/dashboard/TeamsNeedingAttentionWidget.tsx</files>
  <action>
Create a new reusable widget component that displays teams needing attention with a visual breakdown bar:

**Create file: components/dashboard/TeamsNeedingAttentionWidget.tsx**

```tsx
'use client'

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { AlertTriangle, AlertOctagon, CheckCircle2 } from 'lucide-react'
import Link from 'next/link'
import { formatDistanceToNow } from 'date-fns'
import { cn } from '@/lib/utils'

interface Team {
  id: string
  teamName: string
  division: string | null
  healthStatus: string
  percentUsed: number | null
  redFlagCount: number
  lastSynced: Date | null
}

interface TeamsNeedingAttentionWidgetProps {
  teams: Team[]
  associationId?: string
}

export function TeamsNeedingAttentionWidget({
  teams,
  associationId,
}: TeamsNeedingAttentionWidgetProps) {
  // Count teams by status
  const criticalTeams = teams.filter(t => t.healthStatus === 'at_risk')
  const warningTeams = teams.filter(t => t.healthStatus === 'needs_attention')
  const totalTeams = teams.length

  // Calculate percentages for breakdown bar
  const criticalPercent = totalTeams > 0 ? (criticalTeams.length / totalTeams) * 100 : 0
  const warningPercent = totalTeams > 0 ? (warningTeams.length / totalTeams) * 100 : 0

  // Empty state: no teams need attention
  if (totalTeams === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Teams Needing Attention</CardTitle>
          <CardDescription>
            Teams with critical issues or warnings requiring immediate action
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <CheckCircle2 className="mb-3 h-12 w-12 text-green-600" aria-hidden="true" />
            <h3 className="mb-1 text-lg font-semibold">All Teams Looking Good!</h3>
            <p className="text-muted-foreground text-sm">
              No teams require immediate attention at this time.
            </p>
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Teams Needing Attention</CardTitle>
        <CardDescription>
          Teams with critical issues or warnings requiring immediate action
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Visual Breakdown Bar */}
        <div className="space-y-3">
          {/* Stacked bar */}
          <div className="bg-muted flex h-2 w-full overflow-hidden rounded-full">
            {criticalTeams.length > 0 && (
              <div
                className="h-full bg-red-600 transition-all duration-300"
                style={{ width: `${criticalPercent}%` }}
                aria-label={`Critical teams: ${criticalTeams.length} (${criticalPercent.toFixed(1)}%)`}
              />
            )}
            {warningTeams.length > 0 && (
              <div
                className="h-full bg-amber-500 transition-all duration-300"
                style={{ width: `${warningPercent}%` }}
                aria-label={`Warning teams: ${warningTeams.length} (${warningPercent.toFixed(1)}%)`}
              />
            )}
          </div>

          {/* Legend with counts */}
          <div className="flex items-center justify-between gap-4 text-sm">
            {criticalTeams.length > 0 && (
              <div className="flex items-center gap-1.5">
                <AlertOctagon className="h-3.5 w-3.5 text-red-600" aria-hidden="true" />
                <span className="text-muted-foreground">Critical:</span>
                <span className="font-semibold text-red-600">{criticalTeams.length}</span>
              </div>
            )}
            {warningTeams.length > 0 && (
              <div className="flex items-center gap-1.5">
                <AlertTriangle className="h-3.5 w-3.5 text-amber-600" aria-hidden="true" />
                <span className="text-muted-foreground">Warning:</span>
                <span className="font-semibold text-amber-600">{warningTeams.length}</span>
              </div>
            )}
          </div>
        </div>

        {/* Team List */}
        <div className="space-y-3">
          {teams.map(team => {
            const teamHref = associationId
              ? `/association/${associationId}/teams/${team.id}`
              : `/association/teams/${team.id}`

            return (
              <Link
                key={team.id}
                href={teamHref}
                className="hover:bg-muted/50 flex items-center justify-between rounded-lg border p-4 transition-colors"
              >
                <div className="min-w-0 flex-1">
                  <div className="mb-1 flex items-center gap-2">
                    <span className="truncate font-medium">{team.teamName}</span>
                    {team.division && (
                      <span className="text-muted-foreground text-sm">• {team.division}</span>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <HealthBadge status={team.healthStatus} />
                    {team.redFlagCount > 0 && (
                      <Badge variant="outline" className="text-xs">
                        {team.redFlagCount} flag{team.redFlagCount !== 1 ? 's' : ''}
                      </Badge>
                    )}
                  </div>
                </div>
                <div className="ml-4 text-right">
                  {team.percentUsed !== null && (
                    <div className="text-sm font-medium">{team.percentUsed.toFixed(0)}% used</div>
                  )}
                  {team.lastSynced && (
                    <div className="text-muted-foreground text-xs">
                      Updated {formatDistanceToNow(new Date(team.lastSynced), { addSuffix: true })}
                    </div>
                  )}
                </div>
              </Link>
            )
          })}
        </div>
      </CardContent>
    </Card>
  )
}

// Health Status Badge Component (consistent with Plan 06-01)
function HealthBadge({ status }: { status: string }) {
  const config: Record<
    string,
    { label: string; variant: 'success' | 'warning' | 'destructive'; icon: any }
  > = {
    healthy: {
      label: 'Healthy',
      variant: 'success',
      icon: CheckCircle2,
    },
    needs_attention: {
      label: 'Needs Attention',
      variant: 'warning',
      icon: AlertTriangle,
    },
    at_risk: {
      label: 'At Risk',
      variant: 'destructive',
      icon: AlertOctagon,
    },
  }

  const item = config[status] || config.healthy
  const Icon = item.icon

  return (
    <Badge variant={item.variant} className="flex items-center gap-1.5 text-xs">
      <Icon className="h-3.5 w-3.5" aria-hidden="true" />
      <span className="sr-only">Team health: </span>
      {item.label}
    </Badge>
  )
}
```

**Key implementation details:**

1. **Visual Breakdown Bar:**
   - h-2 (8px) height matches progress bars from Plan 06-02
   - rounded-full for pill-shaped ends
   - bg-red-600 for critical, bg-amber-500 for warning (matching badge colors)
   - Segments use percentage width based on counts
   - transition-all duration-300 for smooth size changes if counts update
   - aria-label on each segment for screen reader context

2. **Legend:**
   - Icons: AlertOctagon (critical), AlertTriangle (warning) from Plan 06-01
   - Icon size h-3.5 (14px) consistent with status badges
   - aria-hidden="true" on icons (decorative)
   - Numerical counts with color-coded text (red-600, amber-600)

3. **Empty State:**
   - Shows CheckCircle2 icon with success message
   - No breakdown bar if no teams need attention
   - Clear positive messaging

4. **Team List:**
   - Reuses existing team card layout from association/page.tsx
   - HealthBadge uses Plan 06-01 accessible pattern
   - Links to team detail pages
   - Shows percent used and last synced time

5. **Accessibility:**
   - Breakdown segments have aria-label with percentage
   - Icons have aria-hidden (meaning in text)
   - HealthBadge includes sr-only context text
   - Color + icon + text redundancy throughout

Why display-only (not clickable segments):

- Simpler implementation, lower complexity
- Team list below provides full interactivity
- Breakdown bar is summary visualization, not primary navigation
- Can iterate to clickable in future if user testing shows value
  </action>
  <verify>
  Run: `npm run build` to confirm TypeScript compilation
  Check: TeamsNeedingAttentionWidget component exports correctly
  Check: Component includes breakdown bar with critical/warning segments
  Check: Legend shows icons, labels, and numerical counts
  Check: Empty state shows success message with CheckCircle2 icon
  Check: HealthBadge component uses Plan 06-01 accessible pattern
  </verify>
  <done>
  TeamsNeedingAttentionWidget component created with visual breakdown bar
  Breakdown bar shows proportional segments for critical (red) and warning (amber) teams
  Legend displays numerical counts with color-coded icons
  Empty state shows positive "All Teams Looking Good!" message
  HealthBadge component uses accessible icon + text + sr-only pattern
  TypeScript builds without errors
  </done>
  </task>

<task type="auto">
  <name>Task 2: Replace Teams Needing Attention card with TeamsNeedingAttentionWidget</name>
  <files>app/association/page.tsx</files>
  <action>
Replace the existing Teams Needing Attention Card with the new TeamsNeedingAttentionWidget component:

**Line 1: Add import for new widget component:**

After existing component imports (after line 15), add:

```tsx
import { TeamsNeedingAttentionWidget } from '@/components/dashboard/TeamsNeedingAttentionWidget'
```

**Lines 287-344: Replace entire Teams Needing Attention Card section:**

Remove the existing Card implementation (lines 287-344):

```tsx
{
  /* Teams Needing Attention */
}
;<Card>
  <CardHeader>
    <CardTitle>Teams Needing Attention</CardTitle>
    <CardDescription>
      Teams with critical issues or warnings requiring immediate action
    </CardDescription>
  </CardHeader>
  <CardContent>
    {topAttentionTeams.length === 0 ? (
      <div className="flex flex-col items-center justify-center py-12 text-center">
        <CheckCircle2 className="mb-3 h-12 w-12 text-green-600" />
        <h3 className="mb-1 text-lg font-semibold">All Teams Looking Good!</h3>
        <p className="text-muted-foreground text-sm">
          No teams require immediate attention at this time.
        </p>
      </div>
    ) : (
      <div className="space-y-3">
        {topAttentionTeams.map(team => (
          <Link
            key={team.id}
            href={`/association/teams/${team.id}`}
            className="hover:bg-muted/50 flex items-center justify-between rounded-lg border p-4 transition-colors"
          >
            <div className="min-w-0 flex-1">
              <div className="mb-1 flex items-center gap-2">
                <span className="truncate font-medium">{team.teamName}</span>
                {team.division && (
                  <span className="text-muted-foreground text-sm">• {team.division}</span>
                )}
              </div>
              <div className="flex items-center gap-2">
                <HealthBadge status={team.healthStatus} />
                {team.redFlagCount > 0 && (
                  <Badge variant="outline" className="text-xs">
                    {team.redFlagCount} flag{team.redFlagCount !== 1 ? 's' : ''}
                  </Badge>
                )}
              </div>
            </div>
            <div className="ml-4 text-right">
              {team.percentUsed !== null && (
                <div className="text-sm font-medium">{team.percentUsed.toFixed(0)}% used</div>
              )}
              {team.lastSynced && (
                <div className="text-muted-foreground text-xs">
                  Updated {formatDistanceToNow(new Date(team.lastSynced), { addSuffix: true })}
                </div>
              )}
            </div>
          </Link>
        ))}
      </div>
    )}
  </CardContent>
</Card>
```

Replace with:

```tsx
{
  /* Teams Needing Attention */
}
;<TeamsNeedingAttentionWidget teams={topAttentionTeams} associationId={association.id} />
```

**Lines 394-418: Remove HealthBadge component definition:**

The HealthBadge component is now internal to TeamsNeedingAttentionWidget. Remove the old definition:

```tsx
// Health Status Badge Component
function HealthBadge({ status }: { status: string }) {
  const variants: Record<string, { label: string; className: string }> = {
    healthy: {
      label: 'Healthy',
      className: 'bg-green-100 text-green-800 border-green-200',
    },
    needs_attention: {
      label: 'Needs Attention',
      className: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    },
    at_risk: {
      label: 'At Risk',
      className: 'bg-red-100 text-red-800 border-red-200',
    },
  }

  const variant = variants[status] || variants.healthy

  return (
    <Badge variant="outline" className={`text-xs ${variant.className}`}>
      {variant.label}
    </Badge>
  )
}
```

DELETE this entire function - it's replaced by the HealthBadge inside TeamsNeedingAttentionWidget.

**Note:** The HealthBadge in Task 1 of Plan 06-01 updated the association/page.tsx HealthBadge to use Badge variants with icons. Since we're now removing it entirely and using the widget's internal HealthBadge, those changes from 06-01 Task 4 effectively get superseded by this widget component. The widget's HealthBadge already follows the Plan 06-01 pattern (Badge variants + icons + aria-hidden + sr-only).

**SeverityBadge (lines 420-433): Keep this component**

The SeverityBadge is used in Recent Alerts section (lines 369-385), so it should remain. It was updated in Plan 06-01 Task 4 to use accessible pattern.

Why these changes:

- Encapsulate Teams Needing Attention logic in reusable widget
- Add visual breakdown bar showing critical vs warning distribution
- Consistent with Plan 06-01 accessible badge patterns (already in widget)
- Reduces duplication (HealthBadge moved inside widget)
- Cleaner page.tsx with component extraction
  </action>
  <verify>
  Run: `npm run build` to confirm TypeScript compilation
  Check: TeamsNeedingAttentionWidget imported and used in page.tsx
  Check: Teams Needing Attention section now uses widget component
  Check: HealthBadge definition removed from page.tsx
  Check: SeverityBadge still present for Recent Alerts section
  Visual check: Teams Needing Attention card renders with breakdown bar
  </verify>
  <done>
  Association overview page uses TeamsNeedingAttentionWidget component
  Visual breakdown bar displays critical vs warning team distribution
  Widget shows proportional segments with numerical counts
  HealthBadge logic moved inside widget (removed from page.tsx)
  SeverityBadge retained for Recent Alerts section
  TypeScript builds without errors
  </done>
  </task>

</tasks>

<verification>
**Visual Verification:**

1. **Breakdown Bar Rendering:**
   - Navigate to association overview page
   - Verify breakdown bar appears above team list
   - Verify bar shows 2 segments: red (critical) and amber (warning)
   - Verify segments are proportional to team counts
   - Verify bar is 8px height (h-2), rounded ends

2. **Legend Accuracy:**
   - Verify legend shows "Critical: X" with AlertOctagon icon in red
   - Verify legend shows "Warning: Y" with AlertTriangle icon in amber
   - Verify numerical counts match actual team counts
   - Verify icons are h-3.5 (14px) size

3. **Empty State:**
   - Create test data with no teams needing attention (all healthy)
   - Verify "All Teams Looking Good!" message appears
   - Verify CheckCircle2 icon displays
   - Verify no breakdown bar shown in empty state

4. **Team List:**
   - Verify team cards render below breakdown bar
   - Verify HealthBadge uses icon + text pattern from Plan 06-01
   - Verify clicking team card navigates to team detail page
   - Verify percent used and last synced time display correctly

**Accessibility Verification:**

1. **Screen Reader Test:**
   - Navigate to Teams Needing Attention widget with screen reader
   - Verify breakdown segments announce: "Critical teams: X (Y%)"
   - Verify HealthBadge announces: "Team health: At Risk"
   - Verify icons have aria-hidden (not announced separately)

2. **Color-Blind Simulation:**
   - Use browser color-blind simulation
   - Verify icon shapes distinguish critical (octagon) from warning (triangle)
   - Verify numerical counts provide non-color information
   - Verify text labels ("Critical", "Warning") clear regardless of color perception

3. **Keyboard Navigation:**
   - Tab through team cards
   - Verify each team card is focusable and clickable
   - Verify focus states are visible

**Build Verification:**

```bash
npm run build
```

Must succeed with no TypeScript errors.
</verification>

<success_criteria>

- TeamsNeedingAttentionWidget component created with visual breakdown bar
- Breakdown bar shows proportional segments for critical (red) and warning (amber) teams
- Legend displays numerical counts with color-coded icons (AlertOctagon, AlertTriangle)
- Empty state shows "All Teams Looking Good!" with CheckCircle2 icon
- Association overview page uses TeamsNeedingAttentionWidget component
- HealthBadge logic moved inside widget (removed duplicate from page.tsx)
- Breakdown segments have aria-label for screen readers
- Icons have aria-hidden="true" attribute
- Color + icon + text redundancy for accessibility
- TypeScript builds without errors
- Visual check confirms breakdown bar renders with correct proportions
  </success_criteria>

<output>
After completion, create `.planning/phases/06-component-polish/06-03-SUMMARY.md`
</output>
